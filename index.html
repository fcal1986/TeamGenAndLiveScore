<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Spielr ‚Äì Teams, Turniere & mehr</title>
<meta name="description" content="Teams auslosen, Turniere erstellen, Reihenfolgen bestimmen ‚Äì f√ºr Hobbygruppen, Freunde und B√ºro.">
<!-- Theme & PWA -->
<meta name="theme-color" content="#12122a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Spielr">
<!-- Icons -->
<link rel="icon" type="image/x-icon" href="favicon.ico">
<link rel="icon" type="image/png" sizes="32x32" href="icon-32.png">
<link rel="icon" type="image/png" sizes="16x16" href="icon-16.png">
<link rel="apple-touch-icon" sizes="180x180" href="icon-180.png">
<!-- PWA Manifest -->
<link rel="manifest" href="manifest.json">
<!-- CSP via Server-Header empfohlen, nicht via Meta-Tag in WebView -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.49.4/dist/umd/supabase.min.js" crossorigin="anonymous"></script>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0f1117;
    --surface: #1a1d27;
    --surface2: #22263a;
    --border: #2e3354;
    --accent: #4f7fff;
    --accent2: #7c3aed;
    --accent3: #10b981;
    --accent4: #f59e0b;
    --danger: #ef4444;
    --text: #e8eaf6;
    --text2: #8892b0;
    --text3: #4a5280;
    --radius: 14px;
    --shadow: 0 8px 32px rgba(0,0,0,0.4);
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'Outfit', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }
  .app { max-width: 480px; margin: 0 auto; min-height: 100vh; position: relative; }

  /* Header */
  .header {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 16px 20px;
    display: flex;
    align-items: center;
    gap: 12px;
    position: sticky;
    top: 0;
    z-index: 100;
    backdrop-filter: blur(10px);
  }
  .header h1 { font-size: 18px; font-weight: 700; color: var(--text); flex:1; }
  .header .back-btn {
    background: none; border: none; color: var(--accent); cursor: pointer;
    font-size: 24px; padding: 4px; border-radius: 10px;
    transition: background .2s;
    display: flex; align-items: center; justify-content: center; width: 44px; height: 44px;
    font-weight: 300; line-height: 1;
  }
  .header .back-btn:hover { background: var(--surface2); }

  /* Screens */
  .screen { display: none; flex-direction: column; }
  .screen.active { display: flex; }
  .screen-body { padding: 20px; flex: 1; }

  /* Empty State */
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--text2);
  }
  .empty-state .icon { font-size: 56px; margin-bottom: 16px; }
  .empty-state h3 { font-size: 18px; font-weight: 600; color: var(--text); margin-bottom: 8px; }
  .empty-state p { font-size: 14px; margin-bottom: 24px; }

  /* Buttons */
  .btn {
    display: inline-flex; align-items: center; justify-content: center; gap: 8px;
    padding: 12px 20px; border-radius: var(--radius);
    font-family: 'Outfit', sans-serif; font-size: 15px; font-weight: 600;
    cursor: pointer; border: none; transition: all .2s; text-decoration: none;
  }
  .btn-primary { background: var(--accent); color: #fff; }
  .btn-primary:hover { background: #6b8fff; transform: translateY(-1px); box-shadow: 0 4px 16px rgba(79,127,255,0.4); }
  .btn-secondary { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
  .btn-secondary:hover { background: var(--border); }
  .btn-danger { background: transparent; color: var(--danger); border: 1px solid var(--danger); }
  .btn-danger:hover { background: rgba(239,68,68,0.1); }
  .btn-full { width: 100%; }
  .btn-sm { padding: 8px 14px; font-size: 13px; border-radius: 10px; }
  .btn-icon { width: 36px; height: 36px; padding: 0; border-radius: 10px; }

  /* Cards */
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
    margin-bottom: 12px;
    transition: all .2s;
  }
  .card:hover { border-color: var(--accent); transform: translateY(-1px); }
  .card-row {
    display: flex; align-items: center; gap: 12px;
  }
  .card-info { flex: 1; }
  .card-title { font-size: 16px; font-weight: 600; color: var(--text); }
  .card-sub { font-size: 13px; color: var(--text2); margin-top: 2px; }
  .card-actions { display: flex; gap: 8px; }

  /* Tag */
  .tag {
    display: inline-block;
    padding: 3px 10px; border-radius: 20px;
    font-size: 12px; font-weight: 600;
    background: var(--surface2); color: var(--text2);
  }
  .tag-blue { background: rgba(79,127,255,0.15); color: var(--accent); }
  .tag-green { background: rgba(16,185,129,0.15); color: var(--accent3); }
  .tag-purple { background: rgba(124,58,237,0.15); color: #a78bfa; }
  .tag-amber { background: rgba(245,158,11,0.15); color: var(--accent4); }

  /* FAB */
  .fab {
    position: fixed; bottom: 24px; right: calc(50% - 240px + 20px);
    width: 56px; height: 56px; border-radius: 50%;
    background: var(--accent); color: #fff;
    display: flex; align-items: center; justify-content: center;
    font-size: 24px; cursor: pointer; border: none;
    box-shadow: 0 4px 24px rgba(79,127,255,0.5);
    transition: all .2s; z-index: 50;
  }
  .fab:hover { transform: scale(1.1); background: #6b8fff; }

  /* Modal */
  .modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.7);
    display: flex; align-items: flex-end; justify-content: center;
    z-index: 200; opacity: 0; pointer-events: none; transition: opacity .3s;
  }
  .modal-overlay.open { opacity: 1; pointer-events: all; }
  .modal {
    background: var(--surface); border-radius: 20px 20px 0 0;
    padding: 24px 20px 40px;
    width: 100%; max-width: 480px;
    transform: translateY(100%); transition: transform .3s;
    max-height: 90vh; overflow-y: auto;
  }
  .modal-overlay.open .modal { transform: translateY(0); }
  .modal h2 { font-size: 20px; font-weight: 700; margin-bottom: 20px; }
  .modal-handle {
    width: 40px; height: 4px; background: var(--border);
    border-radius: 2px; margin: 0 auto 20px;
    cursor: grab; touch-action: none;
  }
  .modal-handle:active { cursor: grabbing; }
  /* Modal dragging state */
  .modal.dragging { transition: none; }

  /* Form */
  .form-group { margin-bottom: 16px; }
  .form-group label { display: block; font-size: 13px; font-weight: 600; color: var(--text2); margin-bottom: 6px; }
  .form-group input, .form-group select, .form-group textarea {
    width: 100%; padding: 12px 14px;
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 10px; color: var(--text);
    font-family: 'Outfit', sans-serif; font-size: 15px;
    transition: border .2s; outline: none;
  }
  .form-group input:focus, .form-group select:focus { border-color: var(--accent); }
  .form-group select option { background: var(--surface2); }

  /* Action Grid ‚Äî 3 big + 3 compact */
  .action-grid-primary {
    display: grid; grid-template-columns: 1fr 1fr 1fr;
    gap: 10px; padding: 16px 20px 8px;
  }
  .action-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 16px 10px;
    text-align: center; cursor: pointer; transition: all .2s;
    position: relative; overflow: hidden;
  }
  .action-card::before {
    content: ''; position: absolute; inset: 0;
    background: linear-gradient(135deg, transparent 60%, rgba(79,127,255,0.05));
    pointer-events: none;
  }
  .action-card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: var(--shadow); }
  .action-card:active { transform: scale(0.97); transition: transform .1s; }
  .action-card .action-icon { font-size: 28px; margin-bottom: 7px; }
  .action-card .action-title { font-size: 12px; font-weight: 700; color: var(--text); margin-bottom: 2px; }
  .action-card .action-desc { display: none; } /* hidden in primary grid */

  /* Compact action rows */
  .action-rows { padding: 0 20px 16px; display: flex; flex-direction: column; gap: 8px; }
  .action-row {
    display: flex; align-items: center; gap: 12px;
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 12px; padding: 12px 14px;
    cursor: pointer; transition: all .2s;
  }
  .action-row:hover { border-color: var(--accent); background: var(--surface2); }
  .action-row:active { transform: scale(0.98); transition: transform .1s; }
  .action-row-icon { font-size: 22px; flex-shrink: 0; }
  .action-row-info { flex: 1; }
  .action-row-title { font-size: 14px; font-weight: 700; color: var(--text); }
  .action-row-desc { font-size: 12px; color: var(--text2); margin-top: 1px; }
  .action-row-arrow { color: var(--text3); font-size: 16px; flex-shrink: 0; }

  /* Result display */
  .result-section { margin-bottom: 20px; }
  .result-section h3 { font-size: 15px; font-weight: 700; color: var(--text2); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.05em; }
  .result-team {
    background: var(--surface2); border-radius: 10px; padding: 12px 14px;
    margin-bottom: 8px; display: flex; align-items: center; gap: 10px;
  }
  .result-team-badge {
    width: 28px; height: 28px; border-radius: 8px;
    background: var(--accent); color: #fff; font-size: 13px; font-weight: 700;
    display: flex; align-items: center; justify-content: center; flex-shrink: 0;
  }
  .result-names { font-size: 14px; color: var(--text); }

  /* Stepper */
  .stepper {
    display: flex; align-items: center; gap: 12px;
  }
  .stepper button {
    width: 44px; height: 44px; border-radius: 10px;
    background: var(--surface2); border: 1px solid var(--border);
    color: var(--text); font-size: 20px; cursor: pointer; transition: all .2s;
    display: flex; align-items: center; justify-content: center;
  }
  .stepper button:hover { background: var(--accent); border-color: var(--accent); }
  .stepper .stepper-val {
    font-size: 20px; font-weight: 700; min-width: 40px; text-align: center;
  }

  /* Tabs */
  .tabs {
    display: flex; border-bottom: 1px solid var(--border);
    padding: 0 20px;
  }
  .tab {
    padding: 14px 16px; font-size: 14px; font-weight: 600; color: var(--text2);
    cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -1px;
    transition: all .2s;
  }
  .tab.active { color: var(--accent); border-color: var(--accent); }

  /* Table */
  .standings-table {
    width: 100%; border-collapse: collapse; font-size: 13px;
  }
  .standings-table th {
    padding: 10px 8px; text-align: center; color: var(--text2);
    font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;
    border-bottom: 1px solid var(--border);
  }
  .standings-table th:first-child { text-align: left; padding-left: 12px; }
  .standings-table td {
    padding: 12px 8px; text-align: center; border-bottom: 1px solid var(--border);
  }
  .standings-table td:first-child { text-align: left; padding-left: 12px; }
  .standings-table tr:first-child td { background: rgba(79,127,255,0.08); }
  .standings-table .pos {
    width: 24px; height: 24px; border-radius: 8px;
    background: var(--surface2); font-weight: 700; font-size: 13px;
    display: inline-flex; align-items: center; justify-content: center;
  }
  .standings-table tr:first-child .pos { background: var(--accent4); color: #000; }

  /* Match item */
  .match-item {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 14px 16px; margin-bottom: 10px;
  }
  .match-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
  .match-teams { font-size: 14px; font-weight: 600; color: var(--text); }
  .match-vs { color: var(--text3); margin: 0 8px; }
  .match-score-row { display: flex; align-items: center; gap: 8px; }
  .score-input {
    width: 52px; padding: 8px 4px; text-align: center;
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 8px; color: var(--text); font-size: 18px; font-weight: 700;
    font-family: 'JetBrains Mono', monospace; outline: none;
  }
  .score-input:focus { border-color: var(--accent); }
  .score-sep { font-size: 20px; font-weight: 700; color: var(--text3); }

  /* Tournament sticky progress header */
  .t-detail-header {
    position: sticky; top: 57px; z-index: 90;
    background: var(--surface); border-bottom: 1px solid var(--border);
    padding: 10px 20px;
    display: flex; align-items: center; justify-content: space-between; gap: 12px;
  }
  .t-detail-progress {
    flex: 1; height: 6px; background: var(--border); border-radius: 3px; overflow: hidden;
  }
  .t-detail-progress-fill {
    height: 100%; border-radius: 3px; transition: width .4s ease;
  }
  .t-detail-stats {
    font-size: 12px; font-weight: 700; color: var(--text2); white-space: nowrap;
  }

  /* Winner banner */
  .winner-banner {
    background: linear-gradient(135deg, #f59e0b, #d97706);
    border-radius: var(--radius); padding: 20px; margin-bottom: 20px;
    text-align: center;
  }
  .winner-banner .trophy { font-size: 40px; margin-bottom: 8px; }
  .winner-banner h2 { font-size: 22px; font-weight: 800; color: #000; }
  .winner-banner p { font-size: 14px; color: rgba(0,0,0,0.7); margin-top: 4px; }

  /* Divider */
  .divider { height: 1px; background: var(--border); margin: 20px 0; }

  /* Person chip */
  .person-chip {
    display: inline-flex; align-items: center; gap: 6px;
    border-radius: 20px; padding: 6px 12px; margin: 4px;
    font-size: 13px; font-weight: 600; cursor: pointer;
    border: 2px solid transparent; transition: all .2s; user-select: none;
  }
  .person-chip.active {
    background: rgba(79,127,255,0.15); border-color: var(--accent); color: var(--accent);
  }
  .person-chip.inactive {
    background: var(--surface2); border-color: var(--border); color: var(--text3);
    text-decoration: line-through; opacity: 0.6;
  }
  .person-chip .del-chip {
    background: none; border: none; color: inherit; cursor: pointer;
    font-size: 16px; line-height: 1; padding: 0 0 0 2px; opacity: 0.6; transition: opacity .2s;
  }
  .person-chip .del-chip:hover { opacity: 1; color: var(--danger); }
  .persons-legend {
    display: flex; align-items: center; gap: 16px; margin-bottom: 14px;
    font-size: 12px; color: var(--text2);
  }
  .persons-legend span { display: flex; align-items: center; gap: 5px; }
  .legend-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink:0; }

  /* Notification */
  .toast {
    position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%) translateY(20px);
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 12px; padding: 12px 16px; font-size: 14px; font-weight: 500;
    box-shadow: var(--shadow); z-index: 300; opacity: 0; transition: all .3s; pointer-events: none;
    display: flex; align-items: center; gap: 12px; white-space: nowrap;
  }
  .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); pointer-events: all; }
  .toast-undo {
    background: none; border: none; color: var(--accent);
    font-size: 13px; font-weight: 800; cursor: pointer;
    font-family: Outfit, sans-serif; padding: 2px 0;
    letter-spacing: .02em; flex-shrink: 0;
    text-transform: uppercase;
  }

  /* Swipe-to-delete on list items */
  .list-swipe-wrap {
    position: relative; overflow: hidden;
    border-bottom: 1px solid var(--border);
  }
  .list-delete-bg {
    position: absolute; right: 0; top: 0; bottom: 0;
    background: var(--danger); display: flex; align-items: center;
    padding: 0 24px; color: #fff; font-size: 13px; font-weight: 700;
    gap: 6px; pointer-events: none; opacity: 0; transition: opacity .15s;
    border-radius: 0;
  }
  .list-nav-item {
    transition: transform .2s ease; touch-action: pan-y;
  }
  .list-nav-item.swiping { transition: none; }

  /* History item */
  .history-item {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 16px; margin-bottom: 10px; cursor: pointer;
    transition: all .2s;
  }
  .history-item:hover { border-color: var(--accent); }
  .history-item .hi-header { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
  .history-item .hi-title { flex:1; font-size: 15px; font-weight: 600; }
  .history-item .hi-date { font-size: 12px; color: var(--text3); }
  .history-item .hi-preview { font-size: 13px; color: var(--text2); }

  /* Bracket */
  .bracket-match {
    background: var(--surface2); border-radius: 10px; padding: 10px 12px;
    margin-bottom: 8px; border: 1px solid var(--border);
  }
  .bracket-match .bm-row {
    display: flex; align-items: center; padding: 5px 0;
    border-bottom: 1px solid var(--border); gap: 8px;
  }
  .bracket-match .bm-row:last-child { border-bottom: none; padding-bottom: 0; }
  .bracket-match .bm-name { flex:1; font-size: 14px; font-weight: 500; min-width: 0; }
  .bm-stepper {
    display: flex; align-items: center; gap: 4px; flex-shrink: 0;
  }
  .bm-step-btn {
    width: 44px; height: 44px; border-radius: 10px;
    background: var(--surface); border: 1px solid var(--border);
    color: var(--text); font-size: 20px; font-weight: 700;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
    transition: all .15s; line-height: 1; flex-shrink: 0;
  }
  .bm-step-btn:active { background: var(--accent); border-color: var(--accent); color: #fff; transform: scale(0.92); }
  .bracket-match .bm-score {
    width: 44px; height: 44px; text-align: center;
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 6px; color: var(--text); font-size: 16px; font-weight: 700;
    font-family: 'JetBrains Mono', monospace; outline: none; flex-shrink: 0;
  }
  .bracket-match .bm-score:focus { border-color: var(--accent); }
  .bm-winner { color: var(--accent3); }
  .bm-winner .bm-score { border-color: var(--accent3); color: var(--accent3); }

  /* Section header */
  .section-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 16px 20px 8px;
  }
  .section-header h2 { font-size: 14px; font-weight: 700; color: var(--text2); text-transform: uppercase; letter-spacing: 0.06em; }

  /* Konfig row */
  .config-row {
    display: flex; align-items: center; justify-content: space-between;
    padding: 14px 0; border-bottom: 1px solid var(--border);
  }
  .config-row:last-child { border-bottom: none; }
  .config-label { font-size: 14px; font-weight: 500; }
  .config-sub { font-size: 12px; color: var(--text2); margin-top: 2px; }

  /* Toggle */
  .toggle { position: relative; width: 44px; height: 24px; }
  .toggle input { opacity: 0; width: 0; height: 0; }
  .toggle-slider {
    position: absolute; inset: 0; background: var(--border);
    border-radius: 12px; cursor: pointer; transition: .3s;
  }
  .toggle-slider::before {
    content: ''; position: absolute;
    width: 18px; height: 18px; left: 3px; top: 3px;
    background: white; border-radius: 50%; transition: .3s;
  }
  .toggle input:checked + .toggle-slider { background: var(--accent); }
  .toggle input:checked + .toggle-slider::before { transform: translateX(20px); }

  /* Mini player chips in modal */
  .mini-chip {
    display: inline-flex; align-items: center; gap: 5px;
    border-radius: 16px; padding: 5px 10px; margin: 3px;
    font-size: 13px; font-weight: 600; cursor: pointer;
    border: 2px solid transparent; transition: all .15s; user-select: none;
  }
  .mini-chip.active {
    background: rgba(79,127,255,0.15); border-color: var(--accent); color: var(--accent);
  }
  .mini-chip.inactive {
    background: var(--surface2); border-color: var(--border); color: var(--text3);
    text-decoration: line-through; opacity: 0.55;
  }
  .modal-players-box {
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 10px; padding: 10px; margin-bottom: 4px;
  }
  .modal-players-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 8px; font-size: 13px; font-weight: 700; color: var(--text2);
    text-transform: uppercase; letter-spacing: .05em;
  }
  .modal-add-player {
    display: flex; gap: 6px; margin-top: 10px;
  }
  .modal-add-player input {
    flex: 1; padding: 8px 12px;
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 8px; color: var(--text); font-family: 'Outfit',sans-serif;
    font-size: 14px; outline: none;
  }
  .modal-add-player input:focus { border-color: var(--accent); }
  .modal-add-player button {
    width: 34px; height: 34px; border-radius: 8px;
    background: var(--accent); color: #fff; border: none;
    font-size: 18px; cursor: pointer; flex-shrink: 0;
    display: flex; align-items: center; justify-content: center;
  }

  @media (max-width: 480px) {
    .fab { right: 20px; }
  }

  .badge {
    display: inline-flex; align-items: center; justify-content: center;
    width: 22px; height: 22px; border-radius: 50%;
    background: var(--surface2); color: var(--text2); font-size: 11px; font-weight: 700;
  }

  .list-nav-item {
    display: flex; align-items: center; padding: 16px 20px; border-bottom: 1px solid var(--border);
    cursor: pointer; transition: background .2s; gap: 14px;
  }
  .list-nav-item:hover { background: var(--surface2); }
  .list-nav-item .lni-icon {
    width: 44px; height: 44px; border-radius: 12px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    display: flex; align-items: center; justify-content: center;
    font-size: 20px; flex-shrink: 0;
  }
  .list-nav-item .lni-info { flex: 1; }
  .list-nav-item .lni-name { font-size: 16px; font-weight: 600; }
  .list-nav-item .lni-meta { font-size: 13px; color: var(--text2); margin-top: 2px; }
  .list-nav-item .lni-arrow { color: var(--text3); font-size: 18px; }

  /* Ko bracket visual */
  .ko-round-label {
    font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em;
    color: var(--text3); padding: 10px 0 6px;
  }

  /* ‚îÄ‚îÄ Swipe-hint animation on first load ‚îÄ‚îÄ */
  @keyframes fadeSlideIn {
    from { opacity:0; transform: translateY(8px); }
    to   { opacity:1; transform: translateY(0); }
  }
  .action-card { animation: fadeSlideIn .25s ease both; }
  .action-card:nth-child(1){animation-delay:.02s}
  .action-card:nth-child(2){animation-delay:.06s}
  .action-card:nth-child(3){animation-delay:.10s}
  .action-card:nth-child(4){animation-delay:.14s}
  .action-card:nth-child(5){animation-delay:.18s}
  .action-card:nth-child(6){animation-delay:.22s}

  /* ‚îÄ‚îÄ Active-Banner compact chips ‚îÄ‚îÄ */
  .ab-chip {
    display: inline-flex; align-items: center;
    border-radius: 20px; padding: 4px 11px; margin: 2px;
    font-size: 13px; font-weight: 600; cursor: pointer;
    min-height: 32px; min-width: 44px; justify-content: center;
    transition: all .15s; user-select: none;
  }
  .ab-chip.on  { background:rgba(79,127,255,0.15); border:1.5px solid var(--accent); color:var(--accent); }
  .ab-chip.off { background:var(--surface2); border:1.5px solid var(--border); color:var(--text3); text-decoration:line-through; opacity:.55; }

  /* ‚îÄ‚îÄ Standings table first-place highlight ‚îÄ‚îÄ */
  .standings-table tbody tr:first-child td { background: rgba(79,127,255,0.06); }
  .standings-table tbody tr:first-child .pos {
    background: var(--accent4) !important; color: #000 !important;
  }

  /* ‚îÄ‚îÄ Tournament progress pill ‚îÄ‚îÄ */
  .t-progress { height: 3px; background: var(--border); border-radius: 2px; overflow: hidden; margin-top: 6px; }
  .t-progress-fill { height: 100%; border-radius: 2px; transition: width .4s; }

  /* ‚îÄ‚îÄ Share btn on result screen ‚îÄ‚îÄ */
  .btn-share {
    background: linear-gradient(135deg, #10b981, #059669);
    color: #fff; border: none;
  }
  .btn-share:hover { filter: brightness(1.1); transform: translateY(-1px); }

  /* ‚îÄ‚îÄ Quick-action repeat btn in history ‚îÄ‚îÄ */
  .btn-repeat {
    background: rgba(79,127,255,0.1); border: 1px solid rgba(79,127,255,0.3);
    color: var(--accent); font-size: 12px; font-weight: 700;
    padding: 3px 10px; border-radius: 8px; cursor: pointer; white-space: nowrap;
  }
  .btn-repeat:active { background: rgba(79,127,255,0.25); }

  /* ‚îÄ‚îÄ Empty state CTA pulse ‚îÄ‚îÄ */
  @keyframes pulse-glow {
    0%,100% { box-shadow: 0 0 0 0 rgba(79,127,255,0.4); }
    50%      { box-shadow: 0 0 0 8px rgba(79,127,255,0); }
  }
  .btn-cta-pulse { animation: pulse-glow 2.5s infinite; }

  /* ‚îÄ‚îÄ Tabs: active indicator line ‚îÄ‚îÄ */
  .tab {
    flex: 1; padding: 12px 4px; text-align: center;
    font-size: 12px; font-weight: 600; color: var(--text3);
    cursor: pointer; transition: all .2s; position: relative;
    border-bottom: 2px solid transparent;
  }
  .tab.active { color: var(--accent); border-bottom-color: var(--accent); }

  /* ‚îÄ‚îÄ Persona: scroll input into view on mobile ‚îÄ‚îÄ */
  input, select { scroll-margin-bottom: 20px; }

  /* ‚îÄ‚îÄ Turnier-L√∂schen button subtle ‚îÄ‚îÄ */
  .danger-list-btn {
    background: none; border: none; color: var(--text3); cursor: pointer;
    font-size: 20px; padding: 6px 8px; border-radius: 8px;
    transition: all .15s; min-width: 44px; min-height: 44px;
    display: flex; align-items: center; justify-content: center;
  }
  .danger-list-btn:hover, .danger-list-btn:active { color: var(--danger); background: rgba(239,68,68,0.1); }

  /* ‚îÄ‚îÄ Confirm Dialog Overlay ‚îÄ‚îÄ */
  .confirm-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.75);
    display: flex; align-items: center; justify-content: center;
    z-index: 500; opacity: 0; pointer-events: none; transition: opacity .2s;
  }
  .confirm-overlay.open { opacity: 1; pointer-events: all; }
  .confirm-box {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 18px; padding: 24px 20px; width: calc(100% - 40px);
    max-width: 360px; text-align: center; transform: scale(.95); transition: transform .2s;
  }
  .confirm-overlay.open .confirm-box { transform: scale(1); }
  .confirm-box h3 { font-size: 18px; font-weight: 700; margin-bottom: 8px; }
  .confirm-box p { font-size: 14px; color: var(--text2); margin-bottom: 20px; line-height: 1.5; }
  .confirm-btns { display: flex; gap: 10px; }
  .confirm-btns button { flex: 1; padding: 12px; border-radius: 12px; font-family: Outfit,sans-serif; font-size: 15px; font-weight: 600; cursor: pointer; border: none; }
  .confirm-cancel { background: var(--surface2); color: var(--text); border: 1px solid var(--border) !important; }
  .confirm-ok { background: var(--danger); color: #fff; }

  /* ‚îÄ‚îÄ Result screen stagger animation ‚îÄ‚îÄ */
  @keyframes resultReveal {
    from { opacity: 0; transform: translateX(-16px); }
    to   { opacity: 1; transform: translateX(0); }
  }
  .result-team {
    animation: resultReveal .3s ease both;
  }
  /* JS sets --i on each .result-team for stagger delay */
  .result-team { animation-delay: calc(var(--i, 0) * 80ms); }

  /* ‚îÄ‚îÄ Quick-repeat banner pulse on first show ‚îÄ‚îÄ */
  @keyframes qrPulse {
    0%   { transform: scale(1); }
    50%  { transform: scale(1.01); }
    100% { transform: scale(1); }
  }
  .quick-repeat-pulse { animation: qrPulse .5s ease 0.3s both; }

  /* ‚îÄ‚îÄ Swipe hint ‚îÄ‚îÄ */
  .swipe-hint {
    display: flex; align-items: center; gap: 6px;
    padding: 6px 20px 10px;
    font-size: 11px; color: var(--text3); font-weight: 500;
  }
  @keyframes swipeArrow {
    0%,100% { transform: translateX(0); opacity:.5; }
    50%      { transform: translateX(-6px); opacity:1; }
  }
  .swipe-hint-arrow { animation: swipeArrow 1.5s ease-in-out infinite; display:inline-block; }

  /* ‚îÄ‚îÄ Manage modal person chip ‚îÄ‚îÄ */
  .manage-chip {
    display: inline-flex; align-items: center; gap: 5px;
    border-radius: 16px; padding: 5px 8px 5px 11px; margin: 2px;
    font-size: 13px; font-weight: 600; cursor: pointer;
    border: 2px solid transparent; transition: all .15s; user-select: none;
  }
  .manage-chip.on  { background:rgba(79,127,255,0.15); border-color:var(--accent); color:var(--accent); }
  .manage-chip.off { background:var(--surface2); border-color:var(--border); color:var(--text3); text-decoration:line-through; opacity:.6; }
  .manage-chip .mc-del { background:none; border:none; color:inherit; cursor:pointer; font-size:14px; opacity:.5; padding:0 0 0 2px; transition:opacity .15s; }
  .manage-chip .mc-del:hover { opacity:1; color:var(--danger); }

  /* ‚îÄ‚îÄ Session recall fade in ‚îÄ‚îÄ */
  @keyframes fadeIn { from{opacity:0;transform:translateY(-4px)} to{opacity:1;transform:translateY(0)} }
  #session-recall-banner { animation: fadeIn .3s ease; }
  #quick-repeat-banner   { animation: fadeIn .25s ease; }

  /* ‚ïê‚ïê AUTH SCREEN ‚ïê‚ïê */
  #screen-auth {
    position: fixed; inset: 0; z-index: 1000;
    background: var(--bg);
    display: none; flex-direction: column;
    align-items: center; justify-content: center;
    padding: 32px 20px;
  }
  .auth-card {
    width: 100%; max-width: 380px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 24px;
    padding: 36px 28px 32px;
    box-shadow: 0 24px 64px rgba(0,0,0,0.5);
  }
  .auth-logo-wrap {
    text-align: center; margin-bottom: 28px;
  }
  .auth-logo-icon { font-size: 52px; display: block; margin-bottom: 10px; }
  .auth-logo-title {
    font-size: 26px; font-weight: 800; color: var(--text);
    margin-bottom: 4px; letter-spacing: -.02em;
  }
  .auth-logo-sub { font-size: 14px; color: var(--text2); line-height: 1.5; }

  /* Google Button */
  .auth-google-btn {
    width: 100%; padding: 14px 20px;
    background: #fff; color: #1f1f1f;
    border: none; border-radius: 12px;
    font-family: Outfit, sans-serif; font-size: 15px; font-weight: 700;
    cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;
    transition: all .18s; box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    margin-bottom: 20px;
  }
  .auth-google-btn:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(0,0,0,0.2); }
  .auth-google-btn:active { transform: scale(0.98); }
  .auth-google-btn:disabled { opacity: .5; cursor: not-allowed; transform: none; }
  .auth-google-icon { width: 20px; height: 20px; flex-shrink: 0; }

  /* Divider */
  .auth-divider {
    display: flex; align-items: center; gap: 12px;
    margin-bottom: 20px; color: var(--text3); font-size: 12px; font-weight: 600;
  }
  .auth-divider::before, .auth-divider::after {
    content: ''; flex: 1; height: 1px; background: var(--border);
  }

  /* Magic Link */
  .auth-email-input {
    width: 100%; padding: 13px 16px;
    background: var(--surface2); border: 1.5px solid var(--border);
    border-radius: 10px; color: var(--text);
    font-family: Outfit, sans-serif; font-size: 15px;
    outline: none; transition: border-color .2s; margin-bottom: 10px;
    display: block;
  }
  .auth-email-input:focus { border-color: var(--accent); }
  .auth-email-input::placeholder { color: var(--text3); }

  .auth-magic-btn {
    width: 100%; padding: 13px 20px;
    background: var(--surface2); color: var(--text);
    border: 1.5px solid var(--border); border-radius: 10px;
    font-family: Outfit, sans-serif; font-size: 14px; font-weight: 600;
    cursor: pointer; transition: all .18s;
    display: flex; align-items: center; justify-content: center; gap: 8px;
  }
  .auth-magic-btn:hover:not(:disabled) { border-color: var(--accent); color: var(--accent); }
  .auth-magic-btn:disabled { opacity: .5; cursor: not-allowed; }

  /* States */
  .auth-sent-box {
    text-align: center; display: none;
    animation: authFadeIn .3s ease;
  }
  .auth-sent-icon { font-size: 48px; margin-bottom: 14px; }
  .auth-sent-title { font-size: 19px; font-weight: 700; color: var(--text); margin-bottom: 8px; }
  .auth-sent-sub { font-size: 13px; color: var(--text2); line-height: 1.6; margin-bottom: 20px; }

  .auth-error-box {
    display: none; margin-top: 10px;
    background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.25);
    border-radius: 10px; padding: 11px 14px;
    font-size: 13px; color: #f87171; line-height: 1.5;
  }

  .auth-hint {
    text-align: center; font-size: 12px; color: var(--text3);
    margin-top: 16px; line-height: 1.6;
  }

  /* Loading overlay */
  #auth-loading {
    display: none; position: fixed; inset: 0; z-index: 1100;
    background: var(--bg); align-items: center; justify-content: center;
    flex-direction: column; gap: 16px;
  }
  #auth-loading.show { display: flex; }
  .auth-spinner {
    width: 36px; height: 36px; border: 3px solid var(--border);
    border-top-color: var(--accent); border-radius: 50%;
    animation: spin .7s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  @keyframes authFadeIn {
    from { opacity: 0; transform: translateY(6px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  .auth-loading-text { font-size: 14px; color: var(--text2); font-weight: 600; }
  /* OTP Single Input */
  .otp-single-input {
    width: 100%;
    padding: 18px 20px;
    background: var(--surface2);
    border: 2px solid var(--border);
    border-radius: 14px;
    color: var(--text);
    font-family: 'SF Mono', 'Fira Code', 'Courier New', monospace;
    font-size: 28px;
    font-weight: 800;
    letter-spacing: 10px;
    text-align: center;
    outline: none;
    transition: border-color .2s, box-shadow .2s;
    caret-color: var(--accent);
    margin: 16px 0 12px;
    text-indent: 10px; /* Kompensiert letter-spacing */
  }
  .otp-single-input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(99,102,241,0.15);
  }
  .otp-single-input.filled { border-color: var(--accent3); }
  .otp-single-input.error  {
    border-color: #ef4444;
    animation: otpShake .35s;
  }
  @keyframes otpShake {
    0%,100%{transform:translateX(0)} 20%{transform:translateX(-5px)} 60%{transform:translateX(5px)}
  }
  .otp-verify-btn {
    width: 100%; padding: 14px 20px;
    background: var(--accent); color: #fff;
    border: none; border-radius: 10px;
    font-family: Outfit, sans-serif; font-size: 15px; font-weight: 700;
    cursor: pointer; transition: all .18s; margin-top: 4px;
    display: flex; align-items: center; justify-content: center; gap: 8px;
  }
  .otp-verify-btn:hover:not(:disabled) { filter: brightness(1.1); transform: translateY(-1px); }
  .otp-verify-btn:disabled { opacity: .5; cursor: not-allowed; transform: none; }
  .otp-resend {
    text-align: center; font-size: 12px; color: var(--text3);
    margin-top: 12px; line-height: 1.8;
  }
  .otp-resend button {
    background: none; border: none; color: var(--accent);
    font-size: 12px; font-family: Outfit, sans-serif;
    cursor: pointer; text-decoration: underline; padding: 0;
  }
  .otp-resend button:disabled { color: var(--text3); text-decoration: none; cursor: default; }
  .otp-email-display {
    text-align: center; font-size: 13px; color: var(--text2);
    margin-bottom: 4px; font-weight: 600;
  }
  /* ‚ïê‚ïê DEBUG PANEL ‚ïê‚ïê */
  #debug-panel {
    display: none;
    position: fixed; bottom: 0; left: 0; right: 0; z-index: 9999;
    background: #0a0a0f; border-top: 2px solid #4f7fff;
    max-height: 45vh; flex-direction: column;
    font-family: 'JetBrains Mono', monospace;
  }
  #debug-panel.open { display: flex; }
  #debug-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 8px 12px; background: #111827; border-bottom: 1px solid #1e293b;
    flex-shrink: 0;
  }
  #debug-title { font-size: 11px; font-weight: 700; color: #4f7fff; letter-spacing: .08em; }
  #debug-env { font-size: 10px; color: #64748b; }
  #debug-clear { background: none; border: 1px solid #1e293b; color: #64748b;
    font-size: 10px; padding: 2px 8px; border-radius: 4px; cursor: pointer; }
  #debug-clear:hover { border-color: #ef4444; color: #ef4444; }
  #debug-close { background: none; border: none; color: #64748b; font-size: 16px;
    cursor: pointer; padding: 0 4px; line-height: 1; }
  #debug-log {
    overflow-y: auto; flex: 1; padding: 6px 0;
    font-size: 11px; line-height: 1.6;
  }
  .dlog { display: flex; gap: 8px; padding: 3px 12px; border-bottom: 1px solid #0f172a; }
  .dlog:hover { background: #0f172a; }
  .dlog-time { color: #475569; flex-shrink: 0; font-size: 10px; padding-top: 1px; }
  .dlog-icon { flex-shrink: 0; }
  .dlog-msg { color: #e2e8f0; word-break: break-all; }
  .dlog.ok   .dlog-msg { color: #4ade80; }
  .dlog.err  .dlog-msg { color: #f87171; }
  .dlog.warn .dlog-msg { color: #fbbf24; }
  .dlog.info .dlog-msg { color: #93c5fd; }
  .dlog.evt  .dlog-msg { color: #c084fc; }
  #debug-toggle {
    position: fixed; bottom: 16px; right: 16px; z-index: 9998;
    width: 44px; height: 44px; border-radius: 50%;
    background: #1e293b; border: 2px solid #4f7fff;
    color: #4f7fff; font-size: 18px; cursor: pointer;
    display: none; align-items: center; justify-content: center;
    box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    transition: all .2s;
  }
  #debug-toggle:hover { background: #4f7fff; color: #fff; }
  #debug-badge {
    position: absolute; top: -4px; right: -4px;
    background: #ef4444; color: #fff; font-size: 9px; font-weight: 700;
    border-radius: 8px; padding: 1px 4px; min-width: 16px; text-align: center;
    display: none;
  }

  /* ‚îÄ‚îÄ Sync indicator ‚îÄ‚îÄ */
  #sync-indicator {
    position: fixed; top: 12px; right: 16px; z-index: 400;
    font-size: 11px; font-weight: 700; letter-spacing: .03em;
    padding: 4px 10px; border-radius: 20px;
    transition: all .3s; opacity: 0; pointer-events: none;
  }
  #sync-indicator.saving {
    opacity: 1; background: rgba(79,127,255,0.15); color: var(--accent);
    border: 1px solid rgba(79,127,255,0.3);
  }
  #sync-indicator.saved {
    opacity: 1; background: rgba(16,185,129,0.15); color: var(--accent3);
    border: 1px solid rgba(16,185,129,0.3);
  }
  #sync-indicator.offline {
    opacity: 1; background: rgba(245,158,11,0.15); color: var(--accent4);
    border: 1px solid rgba(245,158,11,0.3);
  }
  #sync-indicator.error {
    opacity: 1; background: rgba(239,68,68,0.15); color: var(--danger);
    border: 1px solid rgba(239,68,68,0.3);
  }

  /* ‚îÄ‚îÄ User menu ‚îÄ‚îÄ */
  .user-btn {
    width: 32px; height: 32px; border-radius: 50%;
    background: var(--accent); color: #fff;
    font-size: 13px; font-weight: 700; border: none;
    cursor: pointer; flex-shrink: 0; display: flex;
    align-items: center; justify-content: center;
    transition: all .2s;
  }
  .user-btn:hover { background: #6b8fff; transform: scale(1.05); }
  #user-menu {
    position: fixed; top: 60px; right: 12px; z-index: 300;
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 12px; padding: 8px; min-width: 200px;
    box-shadow: var(--shadow); display: none;
  }
  #user-menu.open { display: block; }
  .user-menu-email { font-size: 12px; color: var(--text3); padding: 6px 10px 10px; border-bottom: 1px solid var(--border); margin-bottom: 6px; word-break: break-all; }
  .user-menu-btn { width: 100%; background: none; border: none; color: var(--text2); font-family: Outfit, sans-serif; font-size: 14px; font-weight: 600; padding: 10px 12px; border-radius: 8px; cursor: pointer; text-align: left; transition: background .15s; }
  .user-menu-btn:hover { background: var(--surface2); color: var(--text); }
  .user-menu-btn.danger { color: var(--danger); }
  .user-menu-btn.danger:hover { background: rgba(239,68,68,0.1); }
</style>
</head>
<body>

<!-- ===================== AUTH LOADING ===================== -->
<div id="auth-loading">
  <div class="auth-spinner"></div>
  <div class="auth-loading-text" id="auth-loading-text">Anmeldung pr√ºfen‚Ä¶</div>
</div>

<!-- ===================== LOGIN SCREEN ===================== -->
<div id="screen-auth">
  <div class="auth-card">

    <!-- Logo -->
    <div class="auth-logo-wrap">
      <span class="auth-logo-icon">üé≤</span>
      <div class="auth-logo-title">Spielr</div>
      <div class="auth-logo-sub">Teams, Turniere &amp; Abstimmungen<br>f√ºr deine Gruppe</div>
    </div>

    <!-- ‚ë† E-Mail eingeben -->
    <div id="auth-form">

      <!-- Google Button -->
      <button class="auth-google-btn" id="auth-google-btn" onclick="signInWithGoogle()">
        <svg class="auth-google-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
          <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
          <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z" fill="#FBBC05"/>
          <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
        </svg>
        Mit Google anmelden
      </button>

      <div id="auth-google-plugin-hint" style="display:none;margin-top:-8px;margin-bottom:12px;
        background:rgba(251,191,36,0.1);border:1px solid rgba(251,191,36,0.3);
        border-radius:8px;padding:10px 12px;font-size:12px;color:#fbbf24;text-align:center;line-height:1.5">
        ‚ö†Ô∏è Median Social Login Plugin nicht aktiviert.
      </div>

      <div class="auth-divider">oder per E-Mail</div>

      <input class="auth-email-input" id="auth-email" type="email"
        placeholder="deine@email.de" autocomplete="email"
        onkeydown="if(event.key==='Enter'){event.preventDefault();sendOtp()}">
      <button class="auth-magic-btn" id="auth-otp-send-btn" onclick="sendOtp()">
        ‚úâÔ∏è Code per E-Mail senden
      </button>

      <div class="auth-error-box" id="auth-error"></div>
    </div>

    <!-- ‚ë° OTP eingeben -->
    <div id="auth-otp-form" style="display:none;animation:authFadeIn .3s ease">
      <div class="auth-sent-icon" style="font-size:36px;text-align:center;margin-bottom:8px">üì¨</div>
      <div class="auth-sent-title" style="font-size:17px;text-align:center;margin-bottom:4px">Code eingeben</div>
      <div class="otp-email-display" id="otp-email-display"></div>
      <div style="text-align:center;font-size:12px;color:var(--text3);margin-bottom:4px">
        6‚Äì8-stelliger Code ¬∑ g√ºltig 10 Minuten
      </div>

      <!-- Einzelnes gro√ües Eingabefeld ‚Äî funktioniert mit Paste, Tastatur & Autofill -->
      <input
        class="otp-single-input"
        id="otp-input"
        type="text"
        inputmode="numeric"
        pattern="[0-9]*"
        maxlength="8"
        autocomplete="one-time-code"
        placeholder="¬∑ ¬∑ ¬∑ ¬∑ ¬∑ ¬∑ ¬∑ ¬∑"
        oninput="otpSingleInput(this)"
        onpaste="otpSinglePaste(event)"
        onkeydown="if(event.key==='Enter'){event.preventDefault();verifyOtp()}"
        onfocus="this.select()">

      <button class="otp-verify-btn" id="otp-verify-btn" onclick="verifyOtp()" disabled>
        ‚úì Anmelden
      </button>

      <div class="otp-resend">
        <span id="otp-resend-msg">Keinen Code erhalten?</span><br>
        <button id="otp-resend-btn" onclick="resendOtp()" disabled>
          Neuen Code senden (<span id="otp-countdown">60</span>s)
        </button>
      </div>

      <div class="auth-error-box" id="auth-error-otp"></div>

      <div style="text-align:center;margin-top:12px">
        <button onclick="resetAuthForm()" style="background:none;border:none;
          color:var(--text3);font-size:12px;font-family:Outfit,sans-serif;
          cursor:pointer;text-decoration:underline">
          Andere E-Mail verwenden
        </button>
      </div>
    </div>

    <div class="auth-hint">Kein Passwort n√∂tig ¬∑ Deine Daten sind sicher</div>
  </div>
</div>


<!-- ‚ïê‚ïê DEBUG PANEL ‚ïê‚ïê -->
<button id="debug-toggle" title="Debug Log">
  üêõ
  <span id="debug-badge"></span>
</button>
<div id="debug-panel">
  <div id="debug-header">
    <span id="debug-title">üêõ AUTH DEBUG</span>
    <span id="debug-env">‚Äî</span>
    <button id="debug-copy" onclick="debugCopy()" title="Log kopieren"
      style="background:none;border:1px solid #1e293b;color:#64748b;font-size:10px;
      padding:2px 8px;border-radius:4px;cursor:pointer;margin-right:2px">COPY</button>
    <button id="debug-clear" onclick="debugClear()">CLEAR</button>
    <button id="debug-close" onclick="debugToggle()">‚úï</button>
  </div>
  <div id="debug-log"></div>
</div>

<div class="app">

<!-- Sync + User Menu -->
<div id="sync-indicator"></div>
<div id="user-menu">
  <div class="user-menu-email" id="user-menu-email"></div>
  <button class="user-menu-btn" onclick="closeUserMenu()">‚úï Schlie√üen</button>
  <button class="user-menu-btn danger" onclick="signOut()">‚Ü© Abmelden</button>
</div>

<!-- Toast with Undo -->
<div class="toast" id="toast">
  <span id="toast-msg"></span>
  <button class="toast-undo" id="toast-undo-btn" style="display:none" onclick="undoDelete()">R√ºckg√§ngig</button>
</div>

<!-- ===================== SCREEN: LISTEN ===================== -->
<div class="screen active" id="screen-lists">
  <div class="header">
    <h1>üé≤ Spielr</h1>
    <span id="groups-count" style="font-size:12px;color:var(--text3);font-weight:600;flex:1"></span>
    <button class="btn btn-sm btn-primary" onclick="openModal('modal-add-list')">+ Gruppe</button>
    <button class="user-btn" id="user-avatar-btn" onclick="toggleUserMenu()" title="Account" style="display:none">?</button>
  </div>
  <div id="lists-empty" class="empty-state">
    <div class="icon">üé≤</div>
    <h3>Willkommen bei Spielr!</h3>
    <p style="margin-bottom:4px">Teams auslosen, Turniere starten, fair entscheiden.</p>
    <p style="font-size:12px;color:var(--text3);margin-bottom:20px">Teams, Turniere &amp; Abstimmungen ‚Äì f√ºr Hobbyteams, B√ºros &amp; Freundesgruppen.</p>
    <button class="btn btn-primary btn-full btn-cta-pulse" onclick="loadDemoData()" style="margin-bottom:10px">‚ö° Demo starten ‚Äì sofort losspielen</button>
    <button class="btn btn-secondary btn-full" onclick="openModal('modal-add-list')">+ Eigene Gruppe erstellen</button>
  </div>
  <div id="lists-container"></div>
</div>

<!-- ===================== SCREEN: LIST DETAIL ===================== -->
<div class="screen" id="screen-list-detail">
  <div class="header">
    <button class="back-btn" onclick="goBack('screen-lists')" aria-label="Zur√ºck">‚Äπ</button>
    <h1 id="list-detail-title">Gruppe</h1>
    <button class="btn-icon btn btn-secondary" onclick="openModal('modal-rename-list')" title="Umbenennen">‚úèÔ∏è</button>
  </div>
  <div class="tabs">
    <div class="tab active" id="tab-actions" onclick="switchTab('actions')">‚ö° Aktionen</div>
    <div class="tab" id="tab-tournament" onclick="switchTab('tournament')">üèÜ Turnier</div>
    <div class="tab" id="tab-history" onclick="switchTab('history')">üìú Verlauf</div>
    <div class="tab" id="tab-persons" onclick="switchTab('persons')">üë• Gruppe</div>
  </div>
  <!-- Progress bar shows completion across the app -->
  <div id="group-progress-bar" style="height:2px;background:var(--border);display:none">
    <div id="group-progress-fill" style="height:100%;background:var(--accent3);transition:width .4s;width:0%"></div>
  </div>

  <!-- Persons Tab -->
  <div id="tab-content-persons" class="screen-body" style="display:none">
    <div id="persons-empty" class="empty-state" style="padding:40px 20px">
      <div class="icon">üë•</div>
      <h3>Wer spielt heute mit?</h3>
      <p>Namen eintragen und direkt losspielen.</p>
    </div>
    <div id="persons-first-hint" style="display:none;margin:0 20px 8px;background:rgba(79,127,255,0.1);border:1px solid rgba(79,127,255,0.3);border-radius:10px;padding:10px 14px;font-size:13px;color:var(--accent);font-weight:600">
      üëÜ Trage zuerst deine Spieler ein ‚Äì dann kannst du Aktionen starten.
    </div>
    <div id="persons-legend" class="persons-legend" style="display:none">
      <span><span class="legend-dot" style="background:var(--accent)"></span>Dabei</span>
      <span><span class="legend-dot" style="background:var(--border)"></span>Fehlt</span>
      <span id="active-count" style="font-weight:700;color:var(--accent)"></span>
      <button onclick="toggleAllPersons()" style="margin-left:auto;background:none;border:none;color:var(--accent);font-size:12px;font-weight:700;cursor:pointer;font-family:Outfit,sans-serif;padding:2px 0" title="Alle an- oder abw√§hlen" id="toggle-all-btn">Alle an</button>
    </div>
    <div id="persons-chips"></div>
    <div style="padding-top:12px">
      <div style="display:flex;gap:8px">
        <input id="new-person-input" class="form-group" style="flex:1;padding:12px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;color:var(--text);font-family:Outfit;font-size:15px;outline:none"
          placeholder="Name eingeben‚Ä¶" onkeydown="if(event.key==='Enter')addPerson()">
        <button class="btn btn-primary" onclick="addPerson()">+</button>
      </div>
    </div>
  </div>

  <!-- Actions Tab -->
  <div id="tab-content-actions" style="display:block">
    <!-- Quick-Repeat: Letzte Aktion -->
    <div id="quick-repeat-banner" style="display:none;margin:16px 20px 0">
      <div id="quick-repeat-inner"
        style="background:linear-gradient(135deg,rgba(79,127,255,0.12),rgba(124,58,237,0.08));border:1px solid rgba(79,127,255,0.3);border-radius:14px;padding:12px 14px;display:flex;align-items:center;gap:12px;cursor:pointer;transition:all .2s"
        onclick="quickRepeatLastAction()"
        onmouseover="this.style.borderColor='var(--accent)'"
        onmouseout="this.style.borderColor='rgba(79,127,255,0.3)'">
        <div style="font-size:26px;flex-shrink:0" id="quick-repeat-icon">üîÑ</div>
        <div style="flex:1;min-width:0">
          <div style="font-size:11px;font-weight:700;color:var(--accent);text-transform:uppercase;letter-spacing:.06em;margin-bottom:2px">Wiederholen</div>
          <div style="font-size:14px;font-weight:700;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis" id="quick-repeat-label">‚Äì</div>
          <div style="font-size:11px;color:var(--text3);margin-top:1px" id="quick-repeat-meta"></div>
        </div>
        <div style="font-size:20px;color:var(--accent);flex-shrink:0">‚ñ∂</div>
      </div>
    </div>

    <!-- Session-Persistenz: Gleiche Aufstellung? -->
    <div id="session-recall-banner" style="display:none;margin:10px 20px 0">
      <div style="background:rgba(16,185,129,0.08);border:1px solid rgba(16,185,129,0.25);border-radius:12px;padding:10px 14px;display:flex;align-items:center;gap:10px">
        <div style="font-size:20px">üìã</div>
        <div style="flex:1">
          <div style="font-size:13px;font-weight:600;color:var(--text)">Gleiche Aufstellung wie zuletzt?</div>
          <div style="font-size:11px;color:var(--text3);margin-top:1px" id="session-recall-names"></div>
        </div>
        <div style="display:flex;gap:6px;flex-shrink:0">
          <button onclick="applyLastSession()" style="background:var(--accent3);border:none;color:#fff;font-family:Outfit,sans-serif;font-size:12px;font-weight:700;padding:6px 12px;border-radius:8px;cursor:pointer">Ja</button>
          <button onclick="dismissSessionRecall()" style="background:var(--surface2);border:1px solid var(--border);color:var(--text3);font-family:Outfit,sans-serif;font-size:12px;font-weight:600;padding:6px 10px;border-radius:8px;cursor:pointer">‚úï</button>
        </div>
      </div>
    </div>

    <!-- Wer ist dabei Banner -->
    <div id="active-banner" style="margin:10px 20px 4px;background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:12px 14px">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
        <span style="font-size:12px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:.05em">Wer ist heute dabei?</span>
        <button onclick="switchTab('persons')" style="background:none;border:none;color:var(--accent);font-size:12px;font-weight:700;cursor:pointer;font-family:Outfit,sans-serif;padding:4px 0;min-height:32px">Gruppe ‚Üí</button>
      </div>
      <div id="banner-chips" style="display:flex;flex-wrap:wrap;gap:4px"></div>
      <div id="banner-count" style="font-size:11px;font-weight:600;color:var(--text3);margin-top:6px"></div>
    </div>
    <div style="padding:12px 20px 6px">
      <h2 style="font-size:13px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:.06em">Was soll passieren?</h2>
    </div>
    <div class="action-grid-primary">
      <div class="action-card" onclick="openAction('teams')">
        <div class="action-icon">üë•</div>
        <div class="action-title">Teams</div>
      </div>
      <div class="action-card" onclick="openAction('volunteer')">
        <div class="action-icon">üéØ</div>
        <div class="action-title">Freiwillige</div>
      </div>
      <div class="action-card" onclick="startTournamentFromActions()">
        <div class="action-icon">üèÜ</div>
        <div class="action-title">Turnier</div>
      </div>
    </div>
    <div class="action-rows">
      <div class="action-row" onclick="openAction('pairs')">
        <div class="action-row-icon">ü§ù</div>
        <div class="action-row-info">
          <div class="action-row-title">Paare bilden</div>
          <div class="action-row-desc">Zuf√§llige Paare oder Kleingruppen</div>
        </div>
        <div class="action-row-arrow">‚Ä∫</div>
      </div>
      <div class="action-row" onclick="openAction('order')">
        <div class="action-row-icon">üîÄ</div>
        <div class="action-row-info">
          <div class="action-row-title">Startreihenfolge</div>
          <div class="action-row-desc">Wer geht zuerst? Zuf√§llig mischen</div>
        </div>
        <div class="action-row-arrow">‚Ä∫</div>
      </div>
      <div class="action-row" onclick="openAction('allvsall')">
        <div class="action-row-icon">‚öîÔ∏è</div>
        <div class="action-row-info">
          <div class="action-row-title">Alle gegen Alle</div>
          <div class="action-row-desc">Jeder gegen jeden ‚Äì niemand ausgelassen</div>
        </div>
        <div class="action-row-arrow">‚Ä∫</div>
      </div>
    </div>
  </div>

  <!-- History Tab -->
  <div id="tab-content-history" class="screen-body" style="display:none">
    <div id="history-empty" class="empty-state" style="padding:40px 20px">
      <div class="icon">üìú</div>
      <h3>Noch keine Aktionen gespeichert</h3>
      <p>Nach dem Auslosen auf ‚ÄûSpeichern" tippen ‚Äì dann erscheint es hier und kann mit einem Tipp wiederholt werden.</p>
    </div>
    <div id="history-container"></div>
  </div>

  <!-- Tournament Tab -->
  <div id="tab-content-tournament" style="display:none">
    <!-- Tournament List View -->
    <div id="tournament-list-view">
      <div style="padding:16px 20px 8px;display:flex;align-items:center;justify-content:space-between;gap:8px">
        <span style="font-size:14px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:.06em">Turniere</span>
        <div style="display:flex;gap:6px;align-items:center">
          <button id="sort-btn" onclick="toggleTournamentSort()"
            style="background:var(--surface2);border:1px solid var(--border);color:var(--text2);border-radius:8px;padding:4px 10px;font-size:13px;cursor:pointer;transition:all .15s"
            title="Sortierung">A‚Üë</button>
          <button class="btn btn-sm btn-primary" onclick="openModal('modal-new-tournament')">+ Neu</button>
        </div>
      </div>
      <div id="tournaments-empty" class="empty-state" style="padding:40px 20px">
        <div class="icon">üèÜ</div>
        <h3>Noch keine Turniere</h3>
        <p>Erstelle ein Turnier aus deiner Personenliste.</p>
        <button class="btn btn-primary btn-cta-pulse" onclick="openModal('modal-new-tournament')">üèÜ Erstes Turnier erstellen</button>
      </div>
      <div id="tournaments-container" style="padding:0 20px 20px"></div>
    </div>
    <!-- Single Tournament Detail View -->
    <div id="tournament-detail-view" style="display:none">
      <div style="padding:12px 20px 0;display:flex;align-items:center;gap:8px">
        <button class="btn btn-sm btn-secondary" onclick="backToTournamentList()" style="font-size:18px;font-weight:300;padding:6px 14px" aria-label="Zur√ºck">‚Äπ</button>
        <div style="flex:1;font-size:14px;font-weight:700;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap" id="tournament-detail-name"></div>
        <button class="btn btn-sm btn-secondary" onclick="shareTournament()" title="Tabelle teilen">üîó</button>
        <button class="btn btn-sm btn-secondary" onclick="openRenameTournamentModal()" title="Umbenennen">‚úèÔ∏è</button>
        <button class="btn btn-sm btn-danger" onclick="deleteActiveTournament()" title="L√∂schen">üóë</button>
      </div>
      <!-- Sticky progress bar -->
      <div class="t-detail-header" id="t-detail-progress-bar">
        <div class="t-detail-progress">
          <div class="t-detail-progress-fill" id="t-detail-progress-fill"></div>
        </div>
        <div class="t-detail-stats" id="t-detail-stats"></div>
      </div>
      <div class="screen-body" style="padding-top:12px">
        <div id="tournament-view"></div>
      </div>
    </div>
  </div>
</div>

<!-- ===================== SCREEN: ACTION RESULT ===================== -->
<div class="screen" id="screen-result">
  <div class="header">
    <button class="back-btn" onclick="goBack('screen-list-detail')" aria-label="Zur√ºck">‚Äπ</button>
    <h1 id="result-title">Ergebnis</h1>
    <div style="display:flex;gap:6px">
      <button class="btn btn-sm btn-secondary" onclick="goBack('screen-list-detail')" style="font-size:13px;color:var(--text2)">Schlie√üen</button>
    </div>
  </div>
  <div class="screen-body">
    <div id="result-content"></div>
    <div style="margin-top:20px;display:flex;flex-direction:column;gap:10px">
      <button class="btn btn-primary btn-full" onclick="repeatLastAction()" style="font-size:16px;padding:14px">üîÑ Nochmal auslosen</button>
      <div style="display:flex;gap:8px">
        <button class="btn btn-share" style="flex:1" onclick="shareResult()">üîó Teilen</button>
        <button class="btn btn-secondary" style="flex:1" onclick="saveCurrentResult()">üíæ Speichern</button>
      </div>
    </div>
  </div>
</div>

<!-- ===================== SCREEN: HISTORY DETAIL ===================== -->
<div class="screen" id="screen-history-detail">
  <div class="header">
    <button class="back-btn" onclick="goBack('screen-list-detail')" aria-label="Zur√ºck">‚Äπ</button>
    <h1 id="history-detail-title">Ergebnis Details</h1>
    <button class="btn btn-sm btn-danger" onclick="deleteCurrentHistory()">üóë</button>
  </div>
  <div class="screen-body" id="history-detail-content"></div>
</div>

<!-- ===================== MODALS ===================== -->
<!-- Add List -->
<div class="modal-overlay" id="modal-add-list" onclick="closeModalOutside(event,'modal-add-list')">
  <div class="modal">
    <div class="modal-handle"></div>
    <h2>Neue Gruppe erstellen</h2>
    <div class="form-group">
      <label>Name der Gruppe</label>
      <input id="new-list-name" placeholder="z.B. Hobbyteam, B√ºro, Freunde" onkeydown="if(event.key==='Enter')createList()">
    </div>
    <button class="btn btn-primary btn-full" onclick="createList()">Gruppe erstellen</button>
  </div>
</div>

<!-- Rename List / Gruppe verwalten -->
<div class="modal-overlay" id="modal-rename-list" onclick="closeModalOutside(event,'modal-rename-list')">
  <div class="modal">
    <div class="modal-handle"></div>
    <h2>Gruppe verwalten</h2>

    <!-- Name -->
    <div class="form-group">
      <label>Name</label>
      <input id="rename-list-input" placeholder="Neuer Name" onkeydown="if(event.key==='Enter')renameList()">
    </div>

    <!-- Inline Personen-Verwaltung -->
    <div class="form-group">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
        <label style="margin:0">Spieler</label>
        <span id="manage-active-count" style="font-size:12px;color:var(--accent);font-weight:700"></span>
      </div>
      <div class="modal-players-box" style="max-height:160px;overflow-y:auto">
        <div id="manage-person-chips"></div>
      </div>
      <div class="modal-add-player" style="margin-top:8px">
        <input id="manage-new-person" placeholder="Person hinzuf√ºgen‚Ä¶"
          onkeydown="if(event.key==='Enter'){event.preventDefault();addPersonFromManage()}">
        <button onclick="addPersonFromManage()">+</button>
      </div>
    </div>

    <div style="display:flex;gap:8px;margin-top:4px">
      <button class="btn btn-danger" onclick="deleteCurrentList()" style="flex:1">üóë</button>
      <button class="btn btn-primary" onclick="renameList()" style="flex:3">‚úì Speichern</button>
    </div>
  </div>
</div>

<!-- Teams Action -->
<div class="modal-overlay" id="modal-teams" onclick="closeModalOutside(event,'modal-teams')">
  <div class="modal">
    <div class="modal-handle"></div>
    <h2>üë• Teams erstellen</h2>
    <div class="form-group">
      <label>Anzahl Teams</label>
      <div class="stepper">
        <button onclick="changeStep('teams-count',-1)">‚àí</button>
        <span class="stepper-val" id="teams-count">2</span>
        <button onclick="changeStep('teams-count',1)">+</button>
      </div>
    </div>
    <button class="btn btn-primary btn-full" onclick="runTeams()">üé≤ Teams erstellen</button>
  </div>
</div>

<!-- Pairs Action -->
<div class="modal-overlay" id="modal-pairs" onclick="closeModalOutside(event,'modal-pairs')">
  <div class="modal">
    <div class="modal-handle"></div>
    <h2>ü§ù Paare erstellen</h2>
    <div class="form-group">
      <label>Gruppengr√∂√üe</label>
      <div class="stepper">
        <button onclick="changeStep('pairs-size',-1)">‚àí</button>
        <span class="stepper-val" id="pairs-size">2</span>
        <button onclick="changeStep('pairs-size',1)">+</button>
      </div>
    </div>
    <button class="btn btn-primary btn-full" onclick="runPairs()">üé≤ Paare erstellen</button>
  </div>
</div>

<!-- Volunteer Action -->
<div class="modal-overlay" id="modal-volunteer" onclick="closeModalOutside(event,'modal-volunteer')">
  <div class="modal">
    <div class="modal-handle"></div>
    <h2>üéØ Freiwillige auslosen</h2>
    <div class="form-group">
      <label>Anzahl Personen</label>
      <div class="stepper">
        <button onclick="changeStep('volunteer-count',-1)">‚àí</button>
        <span class="stepper-val" id="volunteer-count">1</span>
        <button onclick="changeStep('volunteer-count',1)">+</button>
      </div>
    </div>
    <button class="btn btn-primary btn-full" onclick="runVolunteer()">üé≤ Auslosen</button>
  </div>
</div>

<!-- All vs All -->
<div class="modal-overlay" id="modal-allvsall" onclick="closeModalOutside(event,'modal-allvsall')">
  <div class="modal">
    <div class="modal-handle"></div>
    <h2>‚öîÔ∏è Alle gegen Alle</h2>
    <div class="form-group config-row" style="padding:14px 0">
      <div>
        <div class="config-label">Hin- und R√ºckrunde</div>
        <div class="config-sub">Jede Paarung zweimal</div>
      </div>
      <label class="toggle">
        <input type="checkbox" id="allvsall-return">
        <span class="toggle-slider"></span>
      </label>
    </div>
    <button class="btn btn-primary btn-full" onclick="runAllVsAll()">üé≤ Kombinationen erstellen</button>
  </div>
</div>

<!-- New Tournament -->
<div class="modal-overlay" id="modal-new-tournament" onclick="closeModalOutside(event,'modal-new-tournament')">
  <div class="modal">
    <div class="modal-handle"></div>
    <h2>üèÜ Turnier erstellen</h2>

    <div class="form-group">
      <label>Turniername</label>
      <div style="display:flex;gap:6px">
        <input id="tournament-name-input" placeholder="Name des Turniers‚Ä¶" style="flex:1">
        <button onclick="setTournamentTimestamp()" title="Heutiges Datum als Name eintragen"
          style="flex-shrink:0;padding:0 10px;height:44px;border-radius:10px;background:var(--surface2);border:1px solid var(--border);color:var(--text2);cursor:pointer;font-size:11px;font-weight:700;white-space:nowrap;transition:all .15s;letter-spacing:.02em"
          onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border)'">DATUM</button>
      </div>
    </div>

    <div class="form-group">
      <label>Modus</label>
      <select id="tournament-mode" onchange="onTournamentModeChange()">
        <option value="league">Liga (Round Robin)</option>
        <option value="ko">K.O.-System</option>
      </select>
    </div>

    <!-- Hin- & R√ºckrunde ‚Äì nur bei Liga, einklappbar -->
    <div id="return-round-row" class="form-group" style="padding:2px 0 8px">
      <div style="display:flex;align-items:center;justify-content:space-between;cursor:pointer;padding:8px 0 6px"
           onclick="toggleReturnRoundCollapse()">
        <div style="display:flex;align-items:center;gap:8px">
          <span id="return-round-arrow" style="font-size:12px;color:var(--text2);transition:transform .2s;display:inline-block;transform:rotate(-90deg)">‚ñº</span>
          <div class="config-label" style="margin:0">Hin- und R√ºckrunde</div>
        </div>
        <label class="toggle" onclick="event.stopPropagation()">
          <input type="checkbox" id="league-return-round" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>
      <div id="return-round-body" style="padding:4px 0 4px 20px;transition:all .2s;display:none">
        <div class="config-sub" style="margin-bottom:6px">Jede Paarung wird zweimal gespielt (Hin + R√ºckspiel)</div>
        <!-- Hinrunde/R√ºckrunde labels in Spielplan -->
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <span class="tag tag-blue" style="font-size:11px">Hinrunde</span>
          <span style="font-size:11px;color:var(--text3)">‚Üí</span>
          <span class="tag tag-green" style="font-size:11px">R√ºckrunde</span>
        </div>
      </div>
    </div>

    <div class="form-group">
      <label>Teilnehmer</label>
      <select id="tournament-participants" onchange="onTournamentParticipantsChange()">
        <option value="persons">üë§ Einzelpersonen</option>
        <option value="teams-random">üé≤ Zuf√§llige Teams</option>
        <option value="teams-manual">üèóÔ∏è Teams selbst einteilen</option>
      </select>
    </div>

    <!-- Player status box ‚Äì always visible -->
    <div class="form-group">
      <div class="modal-players-box">
        <div class="modal-players-header">
          <span>üë• Spieler</span>
          <span id="modal-active-count" style="color:var(--accent);font-size:12px"></span>
        </div>
        <div id="modal-player-chips"></div>
        <div class="modal-add-player">
          <input id="modal-new-player" placeholder="Spieler hinzuf√ºgen‚Ä¶"
            onkeydown="if(event.key==='Enter'){event.preventDefault();addPlayerFromModal()}">
          <button onclick="addPlayerFromModal()">+</button>
        </div>
      </div>
    </div>

    <div id="teams-count-row" class="form-group" style="display:none">
      <label>Anzahl Teams</label>
      <div class="stepper">
        <button onclick="changeStep('t-teams-count',-1)">‚àí</button>
        <span class="stepper-val" id="t-teams-count">2</span>
        <button onclick="changeStep('t-teams-count',1)">+</button>
      </div>
    </div>

    <!-- Manual team builder -->
    <div id="manual-teams-builder" style="display:none">
      <div class="modal-players-box" style="margin-bottom:12px">
        <div class="modal-players-header">
          <span>üèóÔ∏è Teams zusammenstellen</span>
          <button onclick="addManualTeam()" style="background:var(--accent);border:none;color:#fff;border-radius:8px;padding:3px 10px;font-size:12px;font-weight:700;cursor:pointer">+ Team</button>
        </div>
        <div id="manual-teams-list"></div>
      </div>
    </div>

    <!-- Erweiterte Einstellungen accordion -->
    <div style="margin-bottom:12px">
      <div onclick="toggleAdvancedSettings()" style="display:flex;align-items:center;justify-content:space-between;cursor:pointer;padding:10px 0;border-top:1px solid var(--border)">
        <span style="font-size:13px;font-weight:600;color:var(--text2)">‚öôÔ∏è Erweiterte Einstellungen</span>
        <span id="adv-arrow" style="font-size:11px;color:var(--text3);transition:transform .2s;display:inline-block;transform:rotate(-90deg)">‚ñº</span>
      </div>
      <div id="adv-settings" style="display:none;padding:4px 0 8px">
        <div class="form-group config-row" style="padding:8px 0">
          <div><div class="config-label">Punkte bei Sieg</div></div>
          <div class="stepper">
            <button onclick="changeStep('pts-win',-1)">‚àí</button>
            <span class="stepper-val" id="pts-win">3</span>
            <button onclick="changeStep('pts-win',1)">+</button>
          </div>
        </div>
        <div class="form-group config-row" style="padding:8px 0;border-bottom:none">
          <div><div class="config-label">Punkte bei Unentschieden</div></div>
          <div class="stepper">
            <button onclick="changeStep('pts-draw',-1)">‚àí</button>
            <span class="stepper-val" id="pts-draw">1</span>
            <button onclick="changeStep('pts-draw',1)">+</button>
          </div>
        </div>
      </div>
    </div>

    <button class="btn btn-primary btn-full" style="margin-top:4px" onclick="createTournament()">üèÜ Turnier erstellen</button>
  </div>
</div>

<!-- Rename Tournament -->
<div class="modal-overlay" id="modal-rename-tournament" onclick="closeModalOutside(event,'modal-rename-tournament')">
  <div class="modal">
    <div class="modal-handle"></div>
    <h2>Turnier umbenennen</h2>
    <div class="form-group">
      <label>Neuer Name</label>
      <input id="rename-tournament-input" placeholder="Turniername">
    </div>
    <button class="btn btn-primary btn-full" onclick="renameTournament()">Umbenennen</button>
  </div>
</div>

<!-- ‚îÄ‚îÄ Custom Confirm Dialog ‚îÄ‚îÄ -->
<div class="confirm-overlay" id="confirm-overlay">
  <div class="confirm-box">
    <h3 id="confirm-title">Sicher?</h3>
    <p id="confirm-msg">Diese Aktion kann nicht r√ºckg√§ngig gemacht werden.</p>
    <div class="confirm-btns">
      <button class="confirm-cancel" onclick="confirmCancel()">Abbrechen</button>
      <button class="confirm-ok" id="confirm-ok-btn" onclick="confirmOK()">L√∂schen</button>
    </div>
  </div>
</div>
</div><!-- /app -->

<script>

// ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
// ‚ïë  DEBUG SYSTEM                                         ‚ïë
// ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
(function() {
  let _debugErrors = 0;
  let _debugInited = false;

  function _ts() {
    const d = new Date();
    return d.getHours().toString().padStart(2,'0') + ':'
      + d.getMinutes().toString().padStart(2,'0') + ':'
      + d.getSeconds().toString().padStart(2,'0') + '.'
      + d.getMilliseconds().toString().padStart(3,'0');
  }

  function _icon(type) {
    return { ok:'‚úÖ', err:'‚ùå', warn:'‚ö†Ô∏è', info:'‚ÑπÔ∏è', evt:'üîî' }[type] || '¬∑';
  }

  window.dbg = function(msg, type) {
    type = type || 'info';
    const log = document.getElementById('debug-log');
    if (!log) { console.log('[DBG]', msg); return; }
    const row = document.createElement('div');
    row.className = 'dlog ' + type;
    row.innerHTML = '<span class="dlog-time">' + _ts() + '</span>'
      + '<span class="dlog-icon">' + _icon(type) + '</span>'
      + '<span class="dlog-msg">' + String(msg).replace(/</g,'&lt;') + '</span>';
    log.appendChild(row);
    log.scrollTop = log.scrollHeight;
    if (type === 'err') {
      _debugErrors++;
      const badge = document.getElementById('debug-badge');
      if (badge) { badge.textContent = _debugErrors; badge.style.display = 'block'; }
    }
    console.log('[DBG ' + type.toUpperCase() + ']', msg);
  };

  window.debugToggle = function() {
    const panel = document.getElementById('debug-panel');
    if (panel) panel.classList.toggle('open');
  };

  window.debugClear = function() {
    const log = document.getElementById('debug-log');
    if (log) log.innerHTML = '';
    _debugErrors = 0;
    const badge = document.getElementById('debug-badge');
    if (badge) badge.style.display = 'none';
  };

  window.debugCopy = function() {
    const log = document.getElementById('debug-log');
    if (!log) return;
    const lines = Array.from(log.querySelectorAll('.dlog')).map(row => {
      const time = row.querySelector('.dlog-time')?.textContent || '';
      const icon = row.querySelector('.dlog-icon')?.textContent || '';
      const msg  = row.querySelector('.dlog-msg')?.textContent || '';
      return time + ' ' + icon + ' ' + msg;
    }).join('\n');
    const header = '=== SPIELR AUTH DEBUG LOG ===\n'
      + 'Zeit: ' + new Date().toISOString() + '\n'
      + 'URL: ' + window.location.href + '\n'
      + 'UA: ' + navigator.userAgent + '\n'
      + '============================\n';
    const text = header + lines;
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text).then(() => {
        const btn = document.getElementById('debug-copy');
        if (btn) { btn.textContent = '‚úì OK'; btn.style.color = '#4ade80';
          setTimeout(() => { btn.textContent = 'COPY'; btn.style.color = '#64748b'; }, 2000); }
      }).catch(() => _debugCopyFallback(text));
    } else {
      _debugCopyFallback(text);
    }
  };

  function _debugCopyFallback(text) {
    const ta = document.createElement('textarea');
    ta.value = text; ta.style.position = 'fixed'; ta.style.opacity = '0';
    document.body.appendChild(ta); ta.select();
    try { document.execCommand('copy'); } catch(e) {}
    document.body.removeChild(ta);
    const btn = document.getElementById('debug-copy');
    if (btn) { btn.textContent = '‚úì OK'; setTimeout(() => btn.textContent = 'COPY', 2000); }
  }

  // Toggle-Button anzeigen & Umgebung erkennen
  document.addEventListener('DOMContentLoaded', function() {
    const toggle = document.getElementById('debug-toggle');
    const envEl = document.getElementById('debug-env');

    // Umgebung erkennen
    const ua = navigator.userAgent || '';
    const isMedian = ua.indexOf('median') > -1 || ua.indexOf('gonative') > -1;
    const isGoNative = !!window.gonative;
    const isIOS = /iPad|iPhone|iPod/.test(ua);
    const isAndroid = /Android/.test(ua);

    const env = (isMedian ? 'MEDIAN' : 'BROWSER')
      + ' | ' + (isAndroid ? 'Android' : isIOS ? 'iOS' : 'Desktop')
      + (isGoNative ? ' | gonative‚úì' : '');

    if (envEl) envEl.textContent = env;

    // Debug immer zeigen (auch im Browser zum Testen)
    if (toggle) toggle.style.display = 'flex';
    toggle && toggle.addEventListener('click', debugToggle);

    dbg('=== SPIELR AUTH DEBUG ===', 'info');
    dbg('Umgebung: ' + env, 'info');
    dbg('URL: ' + window.location.href, 'info');
    dbg('UserAgent: ' + ua.substring(0, 80), 'info');

    // Hash/Query-Parameter pr√ºfen (OAuth Callback Tokens)
    const hash = window.location.hash;
    const search = window.location.search;
    if (hash && hash.length > 1) {
      dbg('Hash gefunden: ' + hash.substring(0, 60) + '‚Ä¶', 'warn');
      if (hash.includes('access_token')) dbg('‚ú¶ access_token in Hash ‚Üí OAuth Callback erkannt!', 'ok');
      if (hash.includes('error')) dbg('Hash-Fehler: ' + hash, 'err');
    } else {
      dbg('Kein OAuth-Hash in URL', 'info');
    }
    if (search && search.includes('code=')) {
      dbg('PKCE code in URL erkannt: ' + search.substring(0, 60), 'ok');
    }

    // window.gonative ‚Äî mit Retry (Median injiziert async)
    function checkBridge(attempt) {
      const gn = window.gonative || window.median;
      if (gn) {
        dbg('Bridge verf√ºgbar nach Versuch ' + attempt + ': ' + (window.median ? 'window.median' : 'window.gonative'), 'ok');
      // Netzwerk-Test: fetch zu Supabase direkt pr√ºfen
      fetch('https://djhxhkhcuvuyozyqmnew.supabase.co/rest/v1/', { method: 'HEAD' })
        .then(r  => dbg('Netzwerk-Test Supabase: HTTP ' + r.status + ' ‚úÖ', 'ok'))
        .catch(e => dbg('Netzwerk-Test Supabase: FEHLER ‚Äì ' + e.message + ' ‚ùå', 'err'));
        dbg('Top-Keys: ' + Object.keys(gn).join(', '), 'info');
        // Social Login pr√ºfen ‚Äî DAS ist entscheidend
        if (gn.socialLogin) {
          dbg('socialLogin: ' + Object.keys(gn.socialLogin).join(', '), 'ok');
          if (gn.socialLogin.google) dbg('google.login: ' + typeof gn.socialLogin.google.login, 'ok');
          else dbg('socialLogin.google: NICHT vorhanden ‚Üí Social Login Plugin nicht aktiviert!', 'err');
        } else {
          dbg('socialLogin: NICHT vorhanden ‚Üí Native Plugin nicht aktiviert!', 'err');
          dbg('‚Üí Im Median Dashboard: Native Plugins ‚Üí Social Login ‚Üí Google aktivieren', 'warn');
        }
        // Alle relevanten Bridge-Keys
        ['inAppBrowser','open','browser','auth0','webview','statusbar'].forEach(k => {
          if (gn[k]) dbg('  bridge.' + k + ': ' + Object.keys(gn[k]).slice(0,5).join(', '), 'info');
        });
      } else if (attempt < 8) {
        if (attempt === 1) dbg('Bridge noch nicht injiziert, warte‚Ä¶', 'info');
        setTimeout(() => checkBridge(attempt + 1), attempt < 4 ? 300 : 600);
      } else {
        dbg('‚ö† Bridge nach ' + attempt + ' Versuchen nicht gefunden', 'warn');
        const bridgeKeys = Object.keys(window).filter(k => /native|median|gonative|bridge/i.test(k));
        dbg('Relevante window-Keys: ' + (bridgeKeys.join(', ') || 'keine'), bridgeKeys.length ? 'info' : 'warn');
      }
    }
    checkBridge(1);
    _debugInited = true;
  });

  // Globale Fehler abfangen
  window.addEventListener('error', function(e) {
    dbg('JS ERROR: ' + e.message + ' @ ' + (e.filename||'?') + ':' + (e.lineno||'?'), 'err');
  });
  window.addEventListener('unhandledrejection', function(e) {
    dbg('UNHANDLED PROMISE: ' + (e.reason?.message || String(e.reason)), 'err');
  });
})();

// ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
// ‚ïë  SUPABASE CONFIG                                      ‚ïë
// ‚ïë  Werte werden von GitHub Actions eingesetzt           ‚ïë
// ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
const BUILD_VERSION = 'v2026-02-28-P';
const SUPABASE_URL  = '%%SUPABASE_URL%%';
const SUPABASE_ANON = '%%SUPABASE_ANON_KEY%%';

// Supabase client ‚Äì null wenn Platzhalter noch nicht ersetzt
// Standard Supabase Client ‚Äî kein fetch-Override (WebView-kompatibel)
const _sb = (SUPABASE_URL && !SUPABASE_URL.startsWith('%%'))
  ? supabase.createClient(SUPABASE_URL, SUPABASE_ANON, {
      auth: { persistSession: true, autoRefreshToken: true }
    })
  : null;

// ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
// ‚ïë  STATE                                                ‚ïë
// ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
let state = {
  lists: [],
  currentListId: null,
  currentHistoryId: null,
  pendingResult: null,
  currentTab: 'actions',
  activeTournamentId: null
};

function getList(id) { return state.lists.find(l => l.id === id); }
function getCurrentList() { return getList(state.currentListId); }

const STATE_VERSION = 2;

// ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
// ‚ïë  PERSIST  (localStorage + Supabase)                  ‚ïë
// ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
let _currentUserId = null;
let _currentToken = null;   // Auth-Token direkt aus onAuthStateChange
let _saveDebounceTimer = null;

function saveLocal() {
  try {
    localStorage.setItem('zgspiele', JSON.stringify({ _v: STATE_VERSION, ...state }));
  } catch(e) { console.warn('Spielr: local save failed', e); }
}

function loadLocal() {
  try {
    const raw = localStorage.getItem('zgspiele');
    if (!raw) return false;
    return applyParsed(JSON.parse(raw));
  } catch(e) {
    console.warn('Spielr: local load failed', e);
    localStorage.removeItem('zgspiele');
    return false;
  }
}

function applyParsed(parsed) {
  if (!parsed) return false;
  const version = parsed._v || 1;
  if (version === 1 && Array.isArray(parsed.lists)) {
    parsed.lists = parsed.lists.map(l => {
      if (l.tournament && !l.tournaments) return { ...l, tournaments: [l.tournament], tournament: undefined };
      if (!l.tournaments) return { ...l, tournaments: [] };
      return l;
    });
  }
  const { _v, pendingResult, currentListId, currentHistoryId, activeTournamentId, currentTab, ...safe } = parsed;
  state = { ...state, ...safe };
  return true;
}

// ‚îÄ‚îÄ Direkter REST-fetch zu Supabase (WebView-sicher) ‚îÄ‚îÄ
async function _sbRestFetch(method, path, body, token) {
  const url = SUPABASE_URL + '/rest/v1/' + path;
  const headers = {
    'apikey': SUPABASE_ANON,
    'Authorization': 'Bearer ' + token,
    'Content-Type': 'application/json',
    'Prefer': method === 'POST' ? 'resolution=merge-duplicates,return=minimal' : ''
  };
  const res = await fetch(url, { method, headers, body: body ? JSON.stringify(body) : undefined });
  if (!res.ok) {
    const txt = await res.text().catch(() => '');
    throw new Error('HTTP ' + res.status + ' ' + txt.substring(0, 100));
  }
  return res.status === 204 ? null : res.json().catch(() => null);
}

function _getToken() {
  // Token kommt direkt aus onAuthStateChange ‚Äî kein async getSession() n√∂tig
  return _currentToken;
}

async function saveToSupabase() {
  if (!_sb || !_currentUserId) return;
  setSyncStatus('saving');
  try {
    const token = _getToken();
    if (!token) { dbg('DB Save: kein Token ‚Üí lokale Daten bleiben', 'warn'); setSyncStatus('error'); return; }
    dbg('DB Save: upsert via REST‚Ä¶', 'info');
    await _sbRestFetch('POST', 'user_data', {
      user_id: _currentUserId,
      data: { _v: STATE_VERSION, ...state },
      updated_at: new Date().toISOString()
    }, token);
    dbg('DB Save: OK ‚úÖ', 'ok');
    setSyncStatus('saved');
  } catch(e) {
    dbg('DB Save Fehler: ' + e.message, 'err');
    setSyncStatus('error');
  }
}

async function loadFromSupabase(userId) {
  if (!_sb) { dbg('DB: kein Client', 'err'); return false; }
  dbg('DB Load: REST fetch f√ºr ' + userId.substring(0,8) + '‚Ä¶', 'info');
  try {
    const token = _getToken();
    if (!token) { dbg('DB Load: kein Token ‚Üí lokale Daten', 'warn'); return false; }
    dbg('DB Load: Token OK, sende Query‚Ä¶', 'info');
    const rows = await _sbRestFetch(
      'GET',
      'user_data?select=data&user_id=eq.' + encodeURIComponent(userId) + '&limit=1',
      null,
      token
    );
    dbg('DB Load: ' + (rows ? rows.length + ' rows' : 'null'), 'ok');
    if (!rows || rows.length === 0) { dbg('DB: Kein Row ‚Üí lokale Daten', 'warn'); return false; }
    const bytes = JSON.stringify(rows[0].data).length;
    dbg('DB: ' + bytes + ' bytes geladen ‚úÖ', 'ok');
    return applyParsed(rows[0].data);
  } catch(e) {
    dbg('DB Load Fehler: ' + e.message, 'err');
    return false;
  }
}

// save() ‚Äì sofort lokal, nach 1.5s in Cloud
function save() {
  saveLocal();
  if (!_sb || !_currentUserId) return;
  if (_saveDebounceTimer) clearTimeout(_saveDebounceTimer);
  setSyncStatus('saving');
  _saveDebounceTimer = setTimeout(() => saveToSupabase(), 1500);
}

// ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
// ‚ïë  SYNC INDICATOR                                       ‚ïë
// ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
let _syncHideTimer = null;

function setSyncStatus(status) {
  const el = document.getElementById('sync-indicator');
  if (!el) return;
  if (_syncHideTimer) clearTimeout(_syncHideTimer);
  const map = { saving: 'üíæ Speichern‚Ä¶', saved: '‚úì Gespeichert', error: '‚ö† Offline gespeichert', offline: '‚óå Offline' };
  el.textContent = map[status] || '';
  el.style.opacity = '1';
  el.style.display = 'flex';
  if (status === 'saved') {
    _syncHideTimer = setTimeout(() => {
      el.style.opacity = '0';
      setTimeout(() => el.style.display = 'none', 400);
    }, 2000);
  }
}

// ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
// ‚ïë  AUTH  ‚Äì  production-ready, Google OAuth + Magic Link ‚ïë
// ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

// ‚îÄ‚îÄ App-URL: Median-sicher, immer korrekte Production-URL ‚îÄ‚îÄ
const APP_URL = 'https://fcal1986.github.io/TeamGenAndLiveScore/index.html';

function getRedirectURL() {
  // Median WebView erkennen (gonative global object)
  const isMedian = !!(window.gonative || (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.gonative));
  return isMedian ? APP_URL : (window.location.origin + window.location.pathname);
}

// ‚îÄ‚îÄ Loading overlay ‚îÄ‚îÄ
function showAuthLoading(msg) {
  const el = document.getElementById('auth-loading');
  const txt = document.getElementById('auth-loading-text');
  if (el) el.classList.add('show');
  if (txt && msg) txt.textContent = msg;
}
function hideAuthLoading() {
  const el = document.getElementById('auth-loading');
  if (el) el.classList.remove('show');
}

// ‚îÄ‚îÄ Sicheres Login+Load: Spinner wird IMMER beendet ‚îÄ‚îÄ
async function _doLoginAndShow(user, token) {
  showAuthLoading('Daten laden‚Ä¶');
  // WICHTIG: UserId + Token ZUERST setzen
  _currentUserId = user.id;
  _currentToken  = token;
  try {
    dbg('Lade Daten f√ºr ' + user.email + '‚Ä¶', 'info');
    // 1. Zuerst lokale Daten laden als Sofort-Fallback
    const hasLocal = loadLocal();
    dbg('Lokale Daten: ' + (hasLocal ? 'vorhanden' : 'keine'), 'info');
    // 2. Supabase versuchen (√ºberschreibt lokale wenn erfolgreich)
    const loaded = await loadFromSupabase(user.id);
    dbg('Supabase Daten: ' + (loaded ? 'OK' : 'Timeout/Fehler ‚Üí behalte lokale'), loaded ? 'ok' : 'warn');
    // 3. Wenn Supabase Daten hat ‚Üí lokal sichern f√ºr n√§chstes Mal
    if (loaded) saveLocal();
    showApp(user);
    renderLists();
    showScreen('screen-lists');
    dbg('‚úÖ App bereit: ' + user.email, 'ok');
  } catch(e) {
    dbg('_doLoginAndShow Fehler: ' + e.message, 'err');
    try { showApp(user); renderLists(); showScreen('screen-lists'); } catch(_) {}
  } finally {
    hideAuthLoading();
  }
}

// ‚îÄ‚îÄ Show / Hide screens ‚îÄ‚îÄ
function showAuthScreen() {
  document.getElementById('screen-auth').style.display = 'flex';
  // Avatar ausblenden
  const avatarBtn = document.getElementById('user-avatar-btn');
  if (avatarBtn) avatarBtn.style.display = 'none';
  // Google-Button vollst√§ndig zur√ºcksetzen
  const googleBtn = document.getElementById('auth-google-btn');
  if (googleBtn) { googleBtn.disabled = false; googleBtn.innerHTML = googleBtnInner(); }
  // Plugin-Hinweis ausblenden
  const hint = document.getElementById('auth-google-plugin-hint');
  if (hint) hint.style.display = 'none';
  // Formulare zur√ºcksetzen
  const authForm = document.getElementById('auth-form');
  if (authForm) authForm.style.display = 'block';
  const otpForm = document.getElementById('auth-otp-form');
  if (otpForm) otpForm.style.display = 'none';
  if (typeof _clearOtpInputs === 'function') _clearOtpInputs();
  _otpEmail = '';
  hideAuthError();
  if (typeof hideOtpError === 'function') hideOtpError();
  const sendBtn = document.getElementById('auth-otp-send-btn');
  if (sendBtn) { sendBtn.disabled = false; sendBtn.textContent = '‚úâÔ∏è Code per E-Mail senden'; }
}

function showApp(user) {
  dbg('showApp: ' + user.email, 'info');
  _currentUserId = user.id;
  document.getElementById('screen-auth').style.display = 'none';
  hideAuthLoading();
  const btn = document.getElementById('user-avatar-btn');
  if (btn) {
    btn.style.display = 'flex';
    const e = user.email || user.user_metadata?.name || '?';
    btn.textContent = e[0].toUpperCase();
    btn.title = user.email || '';
  }
  const menuEmail = document.getElementById('user-menu-email');
  if (menuEmail) {
    const name = user.user_metadata?.full_name || user.user_metadata?.name || '';
    menuEmail.innerHTML = name
      ? '<strong style="color:var(--text);font-size:13px">' + name + '</strong><br>' + (user.email || '')
      : (user.email || '');
  }
}

// ‚îÄ‚îÄ Google OAuth: Median native SDK ODER Browser OAuth ‚îÄ‚îÄ
// Warum: Google verbietet OAuth in WebViews. Median Social Login
// Plugin nutzt natives Google SDK ‚Üí kein Browser n√∂tig.
// Docs: https://docs.median.co/docs/social-login-javascript-callbacks
async function signInWithGoogle() {
  dbg('--- Google Login gestartet ---', 'info');
  if (!_sb) { dbg('FEHLER: _sb null', 'err'); showAuthError('Supabase nicht konfiguriert.'); return; }

  const btn = document.getElementById('auth-google-btn');
  if (btn) { btn.disabled = true; btn.textContent = '‚è≥ Anmelden‚Ä¶'; }

  const ua = navigator.userAgent;
  const isMedian = ua.indexOf('median') > -1 || ua.indexOf('gonative') > -1;
  const gn = window.gonative || window.median;

  dbg('isMedian: ' + isMedian, 'info');
  dbg('window.median: ' + !!window.median, window.median ? 'ok' : 'warn');
  dbg('window.gonative: ' + !!window.gonative, window.gonative ? 'ok' : 'warn');
  if (gn) {
    dbg('Bridge top-keys: ' + Object.keys(gn).join(', '), 'info');
    if (gn.socialLogin) dbg('socialLogin keys: ' + Object.keys(gn.socialLogin).join(', '), 'ok');
    if (gn.socialLogin?.google) dbg('google keys: ' + Object.keys(gn.socialLogin.google).join(', '), 'ok');
  }

  // ‚îÄ‚îÄ PFAD A: Median + Social Login Plugin verf√ºgbar ‚îÄ‚îÄ
  const hasSocialLogin = !!(gn?.socialLogin?.google?.login);
  dbg('Social Login Plugin: ' + hasSocialLogin, hasSocialLogin ? 'ok' : 'warn');

  if (isMedian && hasSocialLogin) {
    dbg('‚Üí Median native Google SDK wird aufgerufen', 'ok');
    try {
      // KEIN nonce-Parameter ‚Äî Median ignoriert ihn und baut ihn nicht
      // in den idToken ein. Supabase w√ºrde dann "Nonces mismatch" melden.
      // Ohne nonce √ºberspringt Supabase die Nonce-Validierung komplett.
      gn.socialLogin.google.login({
        callback: async function(response) {
          dbg('Google SDK Callback empfangen', 'evt');
          if (response.error) {
            dbg('Google SDK Fehler: ' + response.error, 'err');
            showAuthError('Google Login fehlgeschlagen: ' + response.error);
            if (btn) { btn.disabled = false; btn.innerHTML = googleBtnInner(); }
            return;
          }
          const idToken = response.idToken || response.id_token;
          if (!idToken) {
            dbg('Kein idToken in Response: ' + JSON.stringify(response), 'err');
            showAuthError('Kein ID Token erhalten. Social Login Plugin konfiguriert?');
            if (btn) { btn.disabled = false; btn.innerHTML = googleBtnInner(); }
            return;
          }
          dbg('idToken empfangen (' + idToken.length + ' Zeichen)', 'ok');

          dbg('Supabase signInWithIdToken‚Ä¶', 'info');
          try {
            // Kein nonce-Parameter ‚Üí Supabase √ºberspringt Nonce-Check
            const { data: signInData, error: signInErr } = await _sb.auth.signInWithIdToken({
              provider: 'google',
              token: idToken
            });
            if (signInErr) {
              dbg('signInWithIdToken Fehler: ' + signInErr.message, 'err');
              showAuthError('Anmeldung fehlgeschlagen: ' + signInErr.message);
              if (btn) { btn.disabled = false; btn.innerHTML = googleBtnInner(); }
            } else {
              dbg('‚úÖ Google Login OK: ' + signInData?.user?.email, 'ok');
              // onAuthStateChange SIGNED_IN feuert ‚Üí App wird geladen
            }
          } catch(supErr) {
            dbg('Supabase Exception: ' + supErr.message, 'err');
            showAuthError('Fehler: ' + supErr.message);
            if (btn) { btn.disabled = false; btn.innerHTML = googleBtnInner(); }
          }
        }
      });
    } catch(sdkErr) {
      dbg('SDK Exception: ' + sdkErr.message, 'err');
      showAuthError('Google SDK Fehler: ' + sdkErr.message);
      if (btn) { btn.disabled = false; btn.innerHTML = googleBtnInner(); }
    }
    return;
  }

  // ‚îÄ‚îÄ PFAD B: Median aber KEIN Social Login Plugin ‚îÄ‚îÄ
  if (isMedian && !hasSocialLogin) {
    dbg('‚Üí Median ohne Social Login Plugin ‚Üí Hinweis zeigen', 'warn');
    const hint = document.getElementById('auth-google-plugin-hint');
    if (hint) hint.style.display = 'block';
    if (btn) { btn.disabled = false; btn.innerHTML = googleBtnInner(); }
    return;
  }

  // ‚îÄ‚îÄ PFAD C: Browser ‚Üí normales OAuth ‚îÄ‚îÄ
  dbg('‚Üí Browser-Modus: OAuth Redirect', 'info');
  try {
    const { data, error } = await _sb.auth.signInWithOAuth({
      provider: 'google',
      options: {
        redirectTo: APP_URL,
        queryParams: { access_type: 'offline', prompt: 'select_account' }
      }
    });
    if (error) throw error;
    dbg('OAuth Redirect gestartet', 'ok');
  } catch(e) {
    dbg('OAuth Fehler: ' + e.message, 'err');
    showAuthError('Google Login fehlgeschlagen: ' + e.message);
    if (btn) { btn.disabled = false; btn.innerHTML = googleBtnInner(); }
  }
}
function googleBtnInner() {
  return '<svg class="auth-google-icon" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>Mit Google anmelden';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// OTP LOGIN ‚Äî 6-stelliger Code per E-Mail, kein Redirect n√∂tig
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _otpEmail       = '';
let _otpSending     = false;
let _otpCooldownEnd = 0;
let _otpCountdown   = null;

// ‚îÄ‚îÄ Schritt 1: OTP-Code senden ‚îÄ‚îÄ
async function sendOtp() {
  if (!_sb) { showAuthError('Supabase nicht konfiguriert.'); return; }
  if (_otpSending) return;

  const emailEl = document.getElementById('auth-email');
  const email   = emailEl ? emailEl.value.trim().toLowerCase() : '';
  if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
    showAuthError('Bitte eine g√ºltige E-Mail-Adresse eingeben.');
    emailEl && emailEl.focus();
    return;
  }
  if (Date.now() < _otpCooldownEnd) {
    showAuthError('Bitte warte ' + Math.ceil((_otpCooldownEnd - Date.now())/1000) + 's.');
    return;
  }

  _otpSending = true;
  const btn = document.getElementById('auth-otp-send-btn');
  if (btn) { btn.disabled = true; btn.textContent = '‚è≥ Sende‚Ä¶'; }
  hideAuthError();

  try {
    const { error } = await _sb.auth.signInWithOtp({
      email,
      options: { shouldCreateUser: true }
    });

    if (error) {
      const msg = error.message || '';
      if (error.status === 429 || msg.toLowerCase().includes('rate') || msg.toLowerCase().includes('limit')) {
        _otpCooldownEnd = Date.now() + 60000;
        showAuthError('Zu viele Versuche. Bitte 60 Sekunden warten.');
      } else {
        showAuthError('Fehler: ' + msg);
        if (btn) { btn.disabled = false; btn.textContent = '‚úâÔ∏è Code per E-Mail senden'; }
      }
      _otpSending = false;
      return;
    }

    // ‚úÖ OTP-Eingabe anzeigen
    _otpEmail = email;
    document.getElementById('auth-form').style.display = 'none';
    document.getElementById('auth-otp-form').style.display = 'block';
    const disp = document.getElementById('otp-email-display');
    if (disp) disp.textContent = email;
    setTimeout(() => { const d = document.getElementById('otp-input'); if (d) { d.focus(); d.select(); } }, 150);
    _startOtpCountdown(60);

  } catch(e) {
    showAuthError('Netzwerkfehler: ' + e.message);
    if (btn) { btn.disabled = false; btn.textContent = '‚úâÔ∏è Code per E-Mail senden'; }
  }
  _otpSending = false;
}

// ‚îÄ‚îÄ OTP Navigation (Single Input) ‚îÄ‚îÄ
// OTP-L√§nge: 6-8 Stellen werden akzeptiert (Supabase-Einstellung)
// Der Button aktiviert sich ab 6 Stellen, Auto-Submit ab 8 oder Enter
const OTP_MIN = 6;
const OTP_MAX = 8;

function _clearOtpInputs() {
  const inp = document.getElementById('otp-input');
  if (inp) { inp.value = ''; inp.disabled = false; inp.classList.remove('filled', 'error'); }
  const vBtn = document.getElementById('otp-verify-btn');
  if (vBtn) { vBtn.disabled = true; vBtn.textContent = '‚úì Anmelden'; }
}

function otpSingleInput(el) {
  el.value = el.value.replace(/[^0-9]/g, '').slice(0, OTP_MAX);
  el.classList.toggle('filled', el.value.length > 0);
  el.classList.remove('error');
  const vBtn = document.getElementById('otp-verify-btn');
  if (vBtn) vBtn.disabled = el.value.length < OTP_MIN;
  // Auto-Submit wenn Max erreicht
  if (el.value.length === OTP_MAX) verifyOtp();
}

function otpSinglePaste(event) {
  event.preventDefault();
  const text = (event.clipboardData || window.clipboardData).getData('text');
  const digits = text.replace(/[^0-9]/g, '').slice(0, OTP_MAX);
  const inp = document.getElementById('otp-input');
  if (!inp || !digits) return;
  inp.value = digits;
  inp.classList.toggle('filled', digits.length > 0);
  const vBtn = document.getElementById('otp-verify-btn');
  if (vBtn) vBtn.disabled = digits.length < OTP_MIN;
  if (digits.length >= OTP_MIN) setTimeout(verifyOtp, 100);
}

function _getOtpValue() {
  const inp = document.getElementById('otp-input');
  return inp ? inp.value.replace(/[^0-9]/g, '') : '';
}

function otpPaste(event) {
  otpSinglePaste(event);
}

// ‚îÄ‚îÄ Schritt 2: OTP verifizieren ‚îÄ‚îÄ
async function verifyOtp() {
  const token = _getOtpValue();
  if (token.length < OTP_MIN) return;

  const btn = document.getElementById('otp-verify-btn');
  if (btn) { btn.disabled = true; btn.textContent = '‚è≥ Pr√ºfe‚Ä¶'; }
  hideOtpError();
  const otpInp = document.getElementById('otp-input'); if (otpInp) otpInp.disabled = true;

  try {
    const { data, error } = await _sb.auth.verifyOtp({
      email: _otpEmail, token, type: 'email'
    });

    if (error) {
      showOtpError('Falscher oder abgelaufener Code. Bitte erneut versuchen.');
      _clearOtpInputs();
      [0,1,2,3,4,5].forEach(i => {
        const d = document.getElementById('otp-' + i);
        if (d) { d.classList.add('error'); setTimeout(() => d.classList.remove('error'), 400); }
      });
      setTimeout(() => { const d = document.getElementById('otp-input'); if(d) { d.focus(); d.select(); } }, 100);
      if (btn) { btn.disabled = true; }
      return;
    }
    dbg('‚úÖ OTP verifiziert: ' + data?.user?.email, 'ok');
    // onAuthStateChange SIGNED_IN feuert automatisch

  } catch(e) {
    showOtpError('Netzwerkfehler: ' + e.message);
    const otpInpRe = document.getElementById('otp-input'); if (otpInpRe) otpInpRe.disabled = false;
    if (btn) { btn.disabled = false; btn.textContent = '‚úì Anmelden'; }
  }
}

async function resendOtp() {
  if (Date.now() < _otpCooldownEnd) return;
  hideOtpError();
  _clearOtpInputs();
  const { error } = await _sb.auth.signInWithOtp({
    email: _otpEmail, options: { shouldCreateUser: true }
  });
  if (error) {
    showOtpError('Fehler: ' + error.message);
  } else {
    showOtpError('‚úÖ Neuer Code gesendet!');
    setTimeout(hideOtpError, 3000);
    _startOtpCountdown(60);
    setTimeout(() => { const d = document.getElementById('otp-input'); if(d) { d.focus(); d.select(); } }, 100);
  }
}

function _startOtpCountdown(secs) {
  _otpCooldownEnd = Date.now() + secs * 1000;
  const resendBtn = document.getElementById('otp-resend-btn');
  const countEl   = document.getElementById('otp-countdown');
  if (resendBtn) resendBtn.disabled = true;
  if (_otpCountdown) clearInterval(_otpCountdown);
  _otpCountdown = setInterval(() => {
    const rem = Math.ceil((_otpCooldownEnd - Date.now()) / 1000);
    if (rem > 0) {
      if (countEl) countEl.textContent = rem;
    } else {
      clearInterval(_otpCountdown);
      if (resendBtn) { resendBtn.disabled = false; resendBtn.innerHTML = 'Neuen Code senden'; }
    }
  }, 1000);
}

function showOtpError(msg) {
  const el = document.getElementById('auth-error-otp');
  if (el) { el.textContent = msg; el.style.display = 'block'; }
}
function hideOtpError() {
  const el = document.getElementById('auth-error-otp');
  if (el) { el.style.display = 'none'; el.textContent = ''; }
}

// Alias f√ºr Kompatibilit√§t
function sendMagicLink() { sendOtp(); }
function startMagicCooldown() {}

function showAuthError(msg) {
  const el = document.getElementById('auth-error');
  if (el) { el.textContent = msg; el.style.display = 'block'; }
}
function hideAuthError() {
  const el = document.getElementById('auth-error');
  if (el) el.style.display = 'none';
}

function resetAuthForm() {
  // OTP-Form ausblenden, E-Mail-Form zeigen
  document.getElementById('auth-form').style.display = 'block';
  const otpForm = document.getElementById('auth-otp-form');
  if (otpForm) otpForm.style.display = 'none';
  // OTP-Felder leeren
  _clearOtpInputs && _clearOtpInputs();
  _otpEmail = '';
  // Countdown stoppen
  if (_otpCountdown) { clearInterval(_otpCountdown); _otpCountdown = null; }
  hideAuthError();
  hideOtpError && hideOtpError();
  // E-Mail-Feld leeren + fokussieren
  const inp = document.getElementById('auth-email');
  if (inp) { inp.value = ''; inp.focus(); }
  // Send-Button zur√ºcksetzen
  const btn = document.getElementById('auth-otp-send-btn');
  if (btn) { btn.disabled = false; btn.textContent = '‚úâÔ∏è Code per E-Mail senden'; }
}

// ‚îÄ‚îÄ User Menu ‚îÄ‚îÄ
function toggleUserMenu() {
  document.getElementById('user-menu')?.classList.toggle('open');
}
function closeUserMenu() {
  document.getElementById('user-menu')?.classList.remove('open');
}
document.addEventListener('click', e => {
  const menu = document.getElementById('user-menu');
  const btn  = document.getElementById('user-avatar-btn');
  if (menu && btn && !menu.contains(e.target) && !btn.contains(e.target)) {
    menu.classList.remove('open');
  }
});

// ‚îÄ‚îÄ Sign Out ‚îÄ‚îÄ
async function signOut() {
  closeUserMenu();
  setSyncStatus('saving');
  await saveToSupabase();
  if (_sb) await _sb.auth.signOut();
  _currentUserId = null;
  state = { lists:[], currentListId:null, currentHistoryId:null, pendingResult:null, currentTab:'actions', activeTournamentId:null };
  saveLocal();
  resetAuthForm();
  showAuthScreen();
  renderLists();
}

// ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
// ‚ïë  INIT  ‚Äì  stable session bootstrap                    ‚ïë
// ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
// _authInitDone = true NUR wenn User eingeloggt ist und App gezeigt wird.
// NICHT setzen wenn Login-Screen gezeigt wird ‚Äî sonst ignoriert
// onAuthStateChange den SIGNED_IN Event nach Google/Magic-Link Login.
let _authInitDone = false;
let _sessionChecked = false;
let _lastLoginTime = null; // Verhindert doppeltes Ausf√ºhren nach getSession

async function initApp() {
  // ‚îÄ‚îÄ 1. Modal swipe handlers ‚îÄ‚îÄ
  document.querySelectorAll('.modal-overlay').forEach(overlay => {
    const handle = overlay.querySelector('.modal-handle');
    if (!handle) return;
    const id = overlay.id;
    handle.addEventListener('touchstart', e => modalTouchStart(e, id), { passive: true });
    handle.addEventListener('touchmove',  e => modalTouchMove(e, id),  { passive: true });
    handle.addEventListener('touchend',   e => modalTouchEnd(e, id));
    const modal = overlay.querySelector('.modal');
    if (modal) {
      modal.addEventListener('touchstart', e => {
        if (e.touches[0].clientY - modal.getBoundingClientRect().top < 60) modalTouchStart(e, id);
      }, { passive: true });
      modal.addEventListener('touchmove', e => modalTouchMove(e, id), { passive: true });
      modal.addEventListener('touchend',  e => modalTouchEnd(e, id));
    }
  });

  // ‚îÄ‚îÄ 2. Offline/online ‚îÄ‚îÄ
  window.addEventListener('online',  () => { if (_currentUserId) { setSyncStatus('saving'); saveToSupabase(); } });
  window.addEventListener('offline', () => setSyncStatus('offline'));

  // ‚îÄ‚îÄ 3. No Supabase ‚Üí pure localStorage mode ‚îÄ‚îÄ
  if (!_sb) {
    dbg('Supabase NICHT konfiguriert ‚Üí localStorage-Modus', 'warn');
    loadLocal();
    document.getElementById('screen-auth').style.display = 'none';
    renderLists();
    return;
  }
  dbg('BUILD: ' + (typeof BUILD_VERSION !== 'undefined' ? BUILD_VERSION : 'unbekannt'), 'ok');
  dbg('Supabase client: OK', 'ok');
  dbg('Supabase URL: ' + (SUPABASE_URL || 'LEER!'), SUPABASE_URL ? 'ok' : 'err');

  // ‚îÄ‚îÄ 4. Show loading while we check session ‚îÄ‚îÄ
  showAuthLoading('Anmeldung pr√ºfen‚Ä¶');

  // ‚îÄ‚îÄ onAuthStateChange ZUERST registrieren ‚îÄ‚îÄ
  _sb.auth.onAuthStateChange(async (event, session) => {
    dbg('onAuthStateChange: event=' + event + ' | user=' + (session?.user?.email || 'none'), 'evt');

    if ((event === 'SIGNED_IN' || event === 'TOKEN_REFRESHED') && session?.user) {
      if (!_authInitDone) {
        // ‚îÄ‚îÄ Neuer Login (Google, Magic Link, oder erste Session) ‚îÄ‚îÄ
        dbg('‚Üí Login ‚Üí lade App f√ºr ' + session.user.email, 'ok');
        _lastLoginTime = Date.now();
        _authInitDone = true;
        await _doLoginAndShow(session.user, session.access_token);
      } else if (_currentUserId && _currentUserId === session.user.id) {
        // ‚îÄ‚îÄ Echter Token-Refresh f√ºr bereits eingeloggten User ‚îÄ‚îÄ
        dbg('‚Üí Token-Refresh f√ºr ' + session.user.email, 'info');
        _currentUserId = session.user.id;
        _currentToken  = session.access_token;  // Token aktuell halten
      } else if (_currentUserId && _currentUserId !== session.user.id) {
        // ‚îÄ‚îÄ User-Wechsel (unwahrscheinlich aber m√∂glich) ‚îÄ‚îÄ
        dbg('‚Üí User-Wechsel ‚Üí App neu laden', 'warn');
        _authInitDone = true;
        await _doLoginAndShow(session.user, session.access_token);
      }
      // else: _authInitDone=true aber _currentUserId=null ‚Üí login nach signOut,
      // auch als neuer Login behandeln ‚Äî oben durch !_authInitDone abgedeckt nach SIGNED_OUT reset
    } else if (event === 'SIGNED_OUT') {
      // SIGNED_OUT kann automatisch kommen wenn:
      // - Session-Token ung√ºltig/abgelaufen (Supabase invalidiert Session)
      // - signInWithIdToken schl√§gt intern fehl (race condition)
      // - Supabase Web Client ID stimmt nicht mit Token-Audience √ºberein
      const timeSinceLogin = _lastLoginTime ? Math.round((Date.now() - _lastLoginTime) / 1000) : null;
      if (timeSinceLogin !== null && timeSinceLogin < 30) {
        dbg('‚ö†Ô∏è AUTO-LOGOUT nach ' + timeSinceLogin + 's!', 'err');
        dbg('‚Üí Supabase Dashboard pr√ºfen:', 'err');
        dbg('   Auth ‚Üí Providers ‚Üí Google', 'err');
        dbg('   Client ID = Web OAuth Client ID (nicht Android!)', 'err');
        dbg('   Client Secret = Web Client Secret', 'err');
      } else {
        dbg('‚Üí SIGNED_OUT' + (timeSinceLogin ? ' nach ' + timeSinceLogin + 's' : '') + ' (manuell)', 'warn');
      }
      _authInitDone = false;
      _sessionChecked = false;
      _currentUserId = null;
      _currentToken  = null;
      _lastLoginTime = null;
      hideAuthLoading();
      showAuthScreen();
    } else if (event === 'INITIAL_SESSION' && !session) {
      // ‚îÄ‚îÄ Kein User beim App-Start ‚Üí Login-Screen ‚îÄ‚îÄ
      // WICHTIG: _authInitDone bleibt false!
      // Damit SIGNED_IN nach Google/Magic-Link noch verarbeitet wird.
      if (!_sessionChecked) {
        _sessionChecked = true;
        dbg('‚Üí INITIAL_SESSION ohne Session ‚Üí Login-Screen', 'info');
        hideAuthLoading();
        showAuthScreen();
      }
    } else {
      dbg('‚Üí Event ignoriert: ' + event, 'info');
    }
  });

  // ‚îÄ‚îÄ getSession: bestehende Session pr√ºfen ‚îÄ‚îÄ
  dbg('getSession() wird aufgerufen‚Ä¶', 'info');
  const { data: { session: initialSession }, error: sessionError } = await _sb.auth.getSession();
  dbg('getSession(): ' + (initialSession ? 'Session (' + initialSession.user?.email + ')' : 'keine') + (sessionError ? ' | ERR: ' + sessionError.message : ''), initialSession ? 'ok' : 'info');

  if (initialSession?.user && !_authInitDone) {
    // Bestehende Session beim App-Neustart
    dbg('‚Üí Bestehende Session ‚Üí lade App', 'ok');
    _authInitDone = true;
    await _doLoginAndShow(initialSession.user, initialSession.access_token);
    dbg('‚úÖ Session wiederhergestellt: ' + initialSession.user.email, 'ok');
  } else if (!initialSession && !_sessionChecked && !_authInitDone) {
    // getSession meldet keine Session, INITIAL_SESSION hat noch nicht gefeuert
    _sessionChecked = true;
    dbg('‚Üí Keine Session (getSession) ‚Üí Login-Screen', 'info');
    // _authInitDone bleibt false ‚Üí SIGNED_IN nach Login wird verarbeitet!
    hideAuthLoading();
    showAuthScreen();
  } else if (_authInitDone) {
    dbg('‚Üí onAuthStateChange hat bereits eingeloggt', 'info');
  }
}

// Globaler Fehler-Handler: sicherstellen dass Spinner nie ewig h√§ngt
window.addEventListener('unhandledrejection', (e) => {
  dbg('Unhandled Promise Rejection: ' + (e.reason?.message || e.reason), 'err');
  // Falls Loading-Spinner aktiv ‚Üí beenden und Auth-Screen zeigen
  const loading = document.getElementById('auth-loading');
  if (loading && loading.classList.contains('show')) {
    dbg('‚Üí Spinner-Fallback: zeige Login-Screen', 'warn');
    hideAuthLoading();
    if (!_currentUserId) showAuthScreen();
  }
});

window.addEventListener('error', (e) => {
  dbg('JS ERROR: ' + e.message + ' @ ' + e.filename + ':' + e.lineno, 'err');
});

initApp();

// ===================== NAVIGATION =====================
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  window.scrollTo(0,0);
}
function goBack(screenId) { showScreen(screenId); }

// ===================== MODAL =====================
// openModal defined below
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
function closeModalOutside(e, id) {
  if (e.target.classList.contains('modal-overlay')) closeModal(id);
}

// ===================== TOAST =====================
let _toastTimer = null;
function toast(msg, undoFn) {
  const el = document.getElementById('toast');
  const msgEl = document.getElementById('toast-msg');
  const undoBtn = document.getElementById('toast-undo-btn');
  if (_toastTimer) clearTimeout(_toastTimer);
  if (msgEl) msgEl.textContent = msg;
  else { el.textContent = msg; }
  if (undoBtn) {
    undoBtn.style.display = undoFn ? 'block' : 'none';
    _undoFn = undoFn || null;
  }
  el.classList.add('show');
  _toastTimer = setTimeout(() => {
    el.classList.remove('show');
    _undoFn = null;
  }, undoFn ? 5000 : 2500);
}
let _undoFn = null;
function undoDelete() {
  if (_undoFn) { _undoFn(); _undoFn = null; }
  document.getElementById('toast').classList.remove('show');
  if (_toastTimer) clearTimeout(_toastTimer);
}

// ===================== LISTS =====================
function renderLists() {
  const container = document.getElementById('lists-container');
  const empty = document.getElementById('lists-empty');
  const gc = document.getElementById('groups-count');
  if (gc) gc.textContent = state.lists.length ? state.lists.length + ' Gruppen' : '';
  if (!state.lists.length) {
    empty.style.display = 'block'; container.innerHTML = ''; return;
  }
  empty.style.display = 'none';
  container.innerHTML = state.lists.map(l => {
    const histCount = (l.history||[]).length;
    const active = (l.persons||[]).filter(p=>p.active!==false).length;
    const total = (l.persons||[]).length;
    const whoStr = total===0 ? 'Noch niemand dabei' : (active===total ? total+' Spieler' : active+'/'+total+' dabei');
    const histStr = histCount + ' Eintrag' + (histCount!==1?'e':'');
    return `<div class="list-swipe-wrap" id="wrap-${l.id}">
      <div class="list-delete-bg" id="delbg-${l.id}">üóë L√∂schen</div>
      <div class="list-nav-item" id="lni-${l.id}"
        onclick="openList('${l.id}')"
        data-lid="${l.id}"
        ontouchstart="swipeStart(event,this)"
        ontouchmove="swipeMove(event,this)"
        ontouchend="swipeEnd(event,this)">
        <div class="lni-icon">üé≤</div>
        <div class="lni-info">
          <div class="lni-name">${l.name}</div>
          <div class="lni-meta" style="font-size:12px;color:var(--text2)">${whoStr} ¬∑ ${histStr}</div>
        </div>
        <div style="display:flex;align-items:center;gap:4px">
          <button class="danger-list-btn" onclick="event.stopPropagation();deleteListById('${l.id}')" title="Gruppe l√∂schen">üóë</button>
          <div class="lni-arrow">‚Ä∫</div>
        </div>
      </div>
    </div>`;
  }).join('');
  // Swipe hint: shown once, disappears after 4s
  if (!state._swipeHintSeen && state.lists.length > 0) {
    const hint = document.createElement('div');
    hint.className = 'swipe-hint';
    hint.id = 'swipe-hint';
    hint.innerHTML = '<span class="swipe-hint-arrow">‚Üê</span> Nach links wischen zum L√∂schen';
    container.appendChild(hint);
    setTimeout(() => {
      hint.style.transition = 'opacity .5s';
      hint.style.opacity = '0';
      setTimeout(() => hint.remove(), 500);
    }, 3500);
    state._swipeHintSeen = true;
    save();
  }
}

function createList() {
  const name = document.getElementById('new-list-name').value.trim();
  if (!name) return;
  const list = { id: uid(), name, createdAt: Date.now(), persons: [], history: [], tournament: null };
  state.lists.push(list);
  save(); renderLists(); closeModal('modal-add-list');
  document.getElementById('new-list-name').value = '';
  toast('‚úÖ Gruppe erstellt');
}

function openList(id) {
  state.currentListId = id;
  const list = getCurrentList();
  document.getElementById('list-detail-title').textContent = list.name;
  showScreen('screen-list-detail');
  // New group with no persons ‚Üí go to persons tab with inline hint
  if (!list.persons || list.persons.length === 0) {
    switchTab('persons');
    setTimeout(() => {
      const hint = document.getElementById('persons-first-hint');
      if (hint) { hint.style.display = 'block'; setTimeout(() => { hint.style.opacity='0'; hint.style.transition='opacity .5s'; setTimeout(()=>hint.style.display='none', 500); }, 4000); }
      const inp = document.getElementById('new-person-input');
      if (inp) inp.focus();
    }, 300);
  } else {
    switchTab('actions');
  }
}

function renameList() {
  const name = document.getElementById('rename-list-input').value.trim();
  if (!name) return;
  const list = getCurrentList();
  list.name = name;
  document.getElementById('list-detail-title').textContent = name;
  save(); renderLists(); closeModal('modal-rename-list');
  toast('‚úÖ Gruppe umbenannt');
}

function deleteCurrentList() {
  const lid = state.currentListId;
  deleteListById(lid, () => {
    closeModal('modal-rename-list');
    goBack('screen-lists');
  });
}

function deleteListById(lid, afterFn) {
  const list = state.lists.find(l => l.id === lid);
  if (!list) return;
  const idx = state.lists.indexOf(list);
  // Remove
  state.lists = state.lists.filter(l => l.id !== lid);
  save(); renderLists();
  if (afterFn) afterFn();
  // Undo: restore at same position
  toast('üóë ' + list.name + ' gel√∂scht', () => {
    state.lists.splice(idx, 0, list);
    save(); renderLists();
    toast('‚Ü©Ô∏è ' + list.name + ' wiederhergestellt');
  });
}

// ===================== TABS =====================
function switchTab(tab) {
  state.currentTab = tab;
  ['persons','actions','history','tournament'].forEach(t => {
    document.getElementById('tab-'+t).classList.toggle('active', t===tab);
    const el = document.getElementById('tab-content-'+t);
    if (el) el.style.display = t===tab ? 'block' : 'none';
  });
  if (tab==='persons') renderPersons();
  if (tab==='actions') renderActiveBanner();
  if (tab==='history') renderHistory();
  if (tab==='tournament') renderTournament();
}

// ===================== PERSONS =====================
function renderPersons() {
  const list = getCurrentList(); if (!list) return;
  const chips = document.getElementById('persons-chips');
  const empty = document.getElementById('persons-empty');
  const legend = document.getElementById('persons-legend');
  const counter = document.getElementById('active-count');
  if (!list.persons.length) {
    empty.style.display='block'; chips.innerHTML='';
    legend.style.display='none'; return;
  }
  empty.style.display = 'none';
  legend.style.display = 'flex';
  // default active=true for old persons without the property
  list.persons.forEach(p => { if (p.active === undefined) p.active = true; });
  const activeCount = list.persons.filter(p=>p.active).length;
  counter.textContent = activeCount + ' / ' + list.persons.length + ' dabei';
  const toggleAllBtn = document.getElementById('toggle-all-btn');
  if (toggleAllBtn) toggleAllBtn.textContent = activeCount === list.persons.length ? 'Alle ab' : 'Alle an';
  chips.innerHTML = list.persons.map(p =>
    `<span class="person-chip ${p.active?'active':'inactive'}" onclick="togglePerson('${p.id}')">
      ${p.active?'‚úÖ':'‚õî'} ${p.name}
      <button class="del-chip" onclick="event.stopPropagation();deletePerson('${p.id}')">√ó</button>
    </span>`
  ).join('');
}

function addPerson() {
  const input = document.getElementById('new-person-input');
  const name = input.value.trim(); if (!name) return;
  const list = getCurrentList(); if (!list) return;
  list.persons.push({ id: uid(), name, active: true });
  save(); renderPersons(); input.value = '';
}

function deletePerson(pid) {
  const list = getCurrentList(); if (!list) return;
  list.persons = list.persons.filter(p => p.id !== pid);
  save(); renderPersons();
}

function togglePerson(pid) {
  const list = getCurrentList(); if (!list) return;
  const p = list.persons.find(x=>x.id===pid); if (!p) return;
  p.active = !p.active;
  save(); renderPersons(); updateGroupProgress();
}

function toggleAllPersons() {
  const list = getCurrentList(); if (!list) return;
  const allActive = list.persons.every(p=>p.active!==false);
  list.persons.forEach(p => p.active = !allActive);
  save(); renderPersons(); updateGroupProgress();
}

function updateGroupProgress() {
  const list = getCurrentList(); if (!list) return;
  const total = list.persons.length;
  const active = list.persons.filter(p=>p.active!==false).length;
  const bar = document.getElementById('group-progress-bar');
  const fill = document.getElementById('group-progress-fill');
  if (!bar || !fill || total===0) { if(bar) bar.style.display='none'; return; }
  bar.style.display = 'block';
  fill.style.width = Math.round(active/total*100)+'%';
}

function getActivePersons() {
  const list = getCurrentList(); if (!list) return [];
  return list.persons.filter(p => p.active !== false);
}

// ===================== STEPPER =====================
function changeStep(id, delta) {
  const el = document.getElementById(id);
  let v = parseInt(el.textContent) + delta;
  const mins = {'teams-count':2,'pairs-size':2,'volunteer-count':1,'t-teams-count':2,'pts-win':0,'pts-draw':0};
  if (v < (mins[id]||1)) v = mins[id]||1;
  el.textContent = v;
  if (id==='tournament-participants') return;
}

// ===================== ACTIONS =====================
function openAction(type) {
  const list = getCurrentList();
  const activeP = getActivePersons();
  if (!list || activeP.length < 2) { toast('‚ö†Ô∏è Mindestens 2 aktive Personen ben√∂tigt'); return; }
  if (type==='teams') openModal('modal-teams');
  else if (type==='pairs') openModal('modal-pairs');
  else if (type==='volunteer') openModal('modal-volunteer');
  else if (type==='order') runOrder();
  else if (type==='allvsall') openModal('modal-allvsall');
}

function shuffle(arr) {
  const a = [...arr];
  for (let i=a.length-1;i>0;i--) { const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }
  return a;
}

function runTeams() {
  const list = getCurrentList(); if (!list) return;
  const n = parseInt(document.getElementById('teams-count').textContent);
  const ap = getActivePersons();
  if (n > ap.length) { toast('‚ö†Ô∏è Mehr Teams als aktive Personen'); return; }
  const shuffled = shuffle(ap);
  const teams = Array.from({length:n}, ()=>[]);
  shuffled.forEach((p,i) => teams[i%n].push(p.name));
  saveSessionSnapshot();
  state.pendingResult = { type:'teams', title:'Teams erstellen', data: teams };
  closeModal('modal-teams');
  showResult();
}

function runPairs() {
  const list = getCurrentList(); if (!list) return;
  const size = parseInt(document.getElementById('pairs-size').textContent);
  const shuffled = shuffle(getActivePersons());
  const groups = [];
  for (let i=0;i<shuffled.length;i+=size) groups.push(shuffled.slice(i,i+size).map(p=>p.name));
  saveSessionSnapshot();
  state.pendingResult = { type:'pairs', title:`Gruppen (${size}er)`, data: groups };
  closeModal('modal-pairs');
  showResult();
}

function runVolunteer() {
  const list = getCurrentList(); if (!list) return;
  const n = parseInt(document.getElementById('volunteer-count').textContent);
  const avail = getActivePersons();
  if (n > avail.length) { toast('‚ö†Ô∏è Mehr als aktive Personenanzahl'); return; }
  const picked = shuffle(avail).slice(0,n).map(p=>p.name);
  saveSessionSnapshot();
  state.pendingResult = { type:'volunteer', title:`${n} Freiwillige`, data: picked };
  closeModal('modal-volunteer');
  showResult();
}

function runOrder() {
  const list = getCurrentList(); if (!list) return;
  const order = shuffle(getActivePersons()).map(p=>p.name);
  saveSessionSnapshot();
  state.pendingResult = { type:'order', title:'Zuf√§llige Reihenfolge', data: order };
  showResult();
}

function runAllVsAll() {
  const list = getCurrentList(); if (!list) return;
  const returnRound = document.getElementById('allvsall-return').checked;
  const persons = getActivePersons().map(p=>p.name);
  const pairs = [];
  for (let i=0;i<persons.length;i++)
    for (let j=i+1;j<persons.length;j++) {
      pairs.push([persons[i], persons[j]]);
      if (returnRound) pairs.push([persons[j], persons[i]]);
    }
  saveSessionSnapshot();
  state.pendingResult = { type:'allvsall', title:'Alle gegen Alle', data: pairs };
  closeModal('modal-allvsall');
  showResult();
}

function showResult() {
  const r = state.pendingResult; if (!r) return;
  document.getElementById('result-title').textContent = r.title;
  const content = document.getElementById('result-content');

  if (r.type === 'teams') {
    content.innerHTML = r.data.map((team,i) =>
      `<div class="result-team">
        <div class="result-team-badge">${i+1}</div>
        <div class="result-names">${team.join(', ')}</div>
      </div>`
    ).join('');
  } else if (r.type === 'pairs') {
    content.innerHTML = r.data.map((group,i) => {
      const isRest = group.length < parseInt(document.getElementById('pairs-size')?.textContent||2);
      return `<div class="result-team">
        <div class="result-team-badge" style="${isRest?'background:var(--accent4)':''}">${i+1}</div>
        <div class="result-names">${group.join(' + ')}${isRest?' <span class="tag tag-amber">Rest</span>':''}</div>
      </div>`;
    }).join('');
  } else if (r.type === 'volunteer') {
    content.innerHTML = `<div class="result-section"><h3>Ausgew√§hlt</h3>` +
      r.data.map((n,i) => `<div class="result-team">
        <div class="result-team-badge" style="background:var(--accent3)">${i+1}</div>
        <div class="result-names">${n}</div>
      </div>`).join('') + '</div>';
  } else if (r.type === 'order') {
    content.innerHTML = r.data.map((n,i) =>
      `<div class="result-team">
        <div class="result-team-badge" style="background:${i===0?'var(--accent4)':'var(--surface2)'};color:${i===0?'#000':'var(--text)'}">${i+1}</div>
        <div class="result-names">${n}</div>
      </div>`
    ).join('');
  } else if (r.type === 'allvsall') {
    content.innerHTML = r.data.map((pair,i) =>
      `<div class="result-team">
        <div class="result-team-badge" style="background:var(--accent2)">${i+1}</div>
        <div class="result-names">${pair[0]} <span style="color:var(--text3)">vs</span> ${pair[1]}</div>
      </div>`
    ).join('');
  }

  showScreen('screen-result');
  // Stagger animation: set --i CSS var on each result-team
  requestAnimationFrame(() => {
    document.querySelectorAll('#result-content .result-team').forEach((el, i) => {
      el.style.setProperty('--i', i);
    });
  });
}

function saveCurrentResult() {
  const r = state.pendingResult; if (!r) return;
  const list = getCurrentList(); if (!list) return;
  if (!list.history) list.history = [];
  list.history.unshift({ id: uid(), type: r.type, title: r.title, createdAt: Date.now(), data: r.data });
  save();
  toast('‚úÖ Gespeichert ‚Äì im Verlauf mit einem Tipp wiederholbar');
  goBack('screen-list-detail');
  switchTab('actions'); // go back to actions so Quick-Repeat is immediately visible
}

// ===================== HISTORY =====================
const typeLabels = { teams:'üë• Teams', pairs:'ü§ù Paare', volunteer:'üéØ Freiwillige', order:'üîÄ Reihenfolge', allvsall:'‚öîÔ∏è Alle gegen Alle' };

function renderHistory() {
  const list = getCurrentList(); if (!list) return;
  const container = document.getElementById('history-container');
  const empty = document.getElementById('history-empty');
  const hist = list.history || [];
  if (!hist.length) { empty.style.display='block'; container.innerHTML=''; return; }
  empty.style.display = 'none';
  container.innerHTML = hist.map(h => {
    const date = new Date(h.createdAt).toLocaleString('de-DE',{day:'2-digit',month:'2-digit',year:'2-digit',hour:'2-digit',minute:'2-digit'});
    let preview = '';
    if (h.type==='teams') preview = h.data.map((t,i)=>`Team ${i+1}: ${t.join(', ')}`).slice(0,2).join(' | ');
    else if (h.type==='order') preview = h.data.slice(0,3).join(' ‚Üí ')+'‚Ä¶';
    else if (h.type==='pairs') preview = h.data.slice(0,2).map(g=>g.join(' + ')).join(' | ');
    else if (h.type==='volunteer') preview = h.data.join(', ');
    else if (h.type==='allvsall') preview = `${h.data.length} Begegnungen`;
    return `<div class="history-item">
      <div onclick="openHistoryDetail('${h.id}')" style="cursor:pointer">
        <div class="hi-header">
          <span class="tag tag-blue">${typeLabels[h.type]||h.type}</span>
          <span class="hi-date" style="flex:1;margin-left:6px">${date}</span>
          <button class="btn-repeat" onclick="event.stopPropagation();repeatHistory('${h.id}')" title="Nochmal auslosen">üîÑ Wiederholen</button>
          <button onclick="event.stopPropagation();deleteHistory('${h.id}')"
            style="background:none;border:none;color:var(--text3);cursor:pointer;font-size:18px;padding:2px 4px;border-radius:6px;transition:color .2s"
            onmouseover="this.style.color='var(--danger)'" onmouseout="this.style.color='var(--text3)'">√ó</button>
        </div>
        <div class="hi-preview">${preview}</div>
      </div>
    </div>`;
  }).join('');
}

function openHistoryDetail(hid) {
  const list = getCurrentList(); if (!list) return;
  const h = list.history.find(x=>x.id===hid); if (!h) return;
  state.currentHistoryId = hid;
  document.getElementById('history-detail-title').textContent = h.title;
  const content = document.getElementById('history-detail-content');
  state.pendingResult = { type: h.type, title: h.title, data: h.data };
  // reuse showResult logic
  const old = document.getElementById('result-content');
  const clone = content;
  clone.innerHTML = '';
  const tmp = document.createElement('div'); tmp.id='_tmp';
  document.body.appendChild(tmp);
  // just render inline
  if (h.type==='teams') {
    clone.innerHTML = h.data.map((team,i) =>
      `<div class="result-team"><div class="result-team-badge">${i+1}</div><div class="result-names">${team.join(', ')}</div></div>`).join('');
  } else if (h.type==='pairs') {
    clone.innerHTML = h.data.map((group,i) =>
      `<div class="result-team"><div class="result-team-badge">${i+1}</div><div class="result-names">${group.join(' + ')}</div></div>`).join('');
  } else if (h.type==='volunteer') {
    clone.innerHTML = h.data.map((n,i) =>
      `<div class="result-team"><div class="result-team-badge" style="background:var(--accent3)">${i+1}</div><div class="result-names">${n}</div></div>`).join('');
  } else if (h.type==='order') {
    clone.innerHTML = h.data.map((n,i) =>
      `<div class="result-team"><div class="result-team-badge">${i+1}</div><div class="result-names">${n}</div></div>`).join('');
  } else if (h.type==='allvsall') {
    clone.innerHTML = h.data.map((pair,i) =>
      `<div class="result-team"><div class="result-team-badge" style="background:var(--accent2)">${i+1}</div><div class="result-names">${pair[0]} vs ${pair[1]}</div></div>`).join('');
  }
  showScreen('screen-history-detail');
}

function deleteCurrentHistory() {
  const list = getCurrentList(); if (!list) return;
  showConfirm('Eintrag l√∂schen?', 'Dieser Verlaufseintrag wird entfernt.', () => {
    list.history = list.history.filter(h=>h.id!==state.currentHistoryId);
    save(); goBack('screen-list-detail'); switchTab('history');
    toast('üóë Eintrag gel√∂scht');
  });
}

function deleteHistory(hid) {
  const list = getCurrentList(); if (!list) return;
  list.history = list.history.filter(h=>h.id!==hid);
  save(); renderHistory();
  toast('üóë Eintrag gel√∂scht');
}

// ===================== TOURNAMENT =====================
function onTournamentModeChange() {
  const mode = document.getElementById('tournament-mode').value;
  document.getElementById('return-round-row').style.display = mode==='league' ? 'block' : 'none';
}

function toggleReturnRoundCollapse() {
  const body = document.getElementById('return-round-body');
  const arrow = document.getElementById('return-round-arrow');
  const collapsed = body.style.display === 'none';
  body.style.display = collapsed ? 'block' : 'none';
  arrow.style.transform = collapsed ? 'rotate(0deg)' : 'rotate(-90deg)';
}

function onTournamentParticipantsChange() {
  const val = document.getElementById('tournament-participants').value;
  document.getElementById('teams-count-row').style.display = val==='teams-random' ? 'block' : 'none';
  document.getElementById('manual-teams-builder').style.display = val==='teams-manual' ? 'block' : 'none';
  if (val==='teams-random') { document.getElementById('teams-count-row').style.display='block'; }
  if (val==='teams-manual') renderManualTeamsBuilder();
}

// ‚îÄ‚îÄ Manual team builder state ‚îÄ‚îÄ
let manualTeams = []; // [{id, name, members:[personName,...]}]

function renderManualTeamsBuilder() {
  const list = getCurrentList(); if (!list) return;
  const activePlayers = list.persons.filter(p=>p.active!==false).map(p=>p.name);
  const el = document.getElementById('manual-teams-list'); if (!el) return;

  if (!manualTeams.length) {
    manualTeams = [
      {id:uid(), name:'Team 1', members:[]},
      {id:uid(), name:'Team 2', members:[]}
    ];
  }

  const assigned = new Set(manualTeams.flatMap(t=>t.members));
  const unassigned = activePlayers.filter(n=>!assigned.has(n));

  let html = '';

  if (unassigned.length) {
    html += '<div style="margin-bottom:10px">';
    html += '<div style="font-size:11px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.05em;margin-bottom:6px">Nicht zugewiesen</div>';
    html += '<div>' + unassigned.map(n=>`<span class="mini-chip active" style="cursor:pointer" onclick="assignPlayerToTeam(this)"
      data-player="${n.replace(/"/g,'&quot;')}">üë§ ${n}</span>`).join('') + '</div>';
    html += '</div>';
  }

  manualTeams.forEach((team, ti) => {
    html += `<div style="background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:10px;margin-bottom:8px">`;
    html += `<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">`;
    html += `<input value="${team.name.replace(/"/g,'&quot;')}" data-ti="${ti}"
      onblur="manualTeams[parseInt(this.dataset.ti)].name=this.value"
      style="flex:1;background:transparent;border:none;border-bottom:1px solid var(--border);color:var(--text);font-family:Outfit,sans-serif;font-size:14px;font-weight:700;outline:none;padding:2px 4px">`;
    html += `<button onclick="removeManualTeam('${team.id}')" style="background:none;border:none;color:var(--text3);cursor:pointer;font-size:18px;line-height:1">√ó</button>`;
    html += `</div>`;
    html += '<div style="min-height:28px">';
    if (team.members.length) {
      html += team.members.map(mbr =>
        `<span class="mini-chip active" style="cursor:pointer" onclick="unassignMember(this)"
          data-tid="${team.id}" data-player="${mbr.replace(/"/g,'&quot;')}">‚úÖ ${mbr} √ó</span>`
      ).join('');
    } else {
      html += '<span style="font-size:12px;color:var(--text3)">Spieler antippen zum Hinzuf√ºgen</span>';
    }
    html += '</div></div>';
  });

  el.innerHTML = html;
}

function assignPlayerToTeam(el) {
  const name = el.getAttribute('data-player');
  if (manualTeams.length === 1) {
    manualTeams[0].members.push(name);
  } else {
    const target = manualTeams.reduce((a,b)=>a.members.length<=b.members.length?a:b);
    target.members.push(name);
  }
  renderManualTeamsBuilder();
}

function unassignMember(el) {
  const tid = el.getAttribute('data-tid');
  const name = el.getAttribute('data-player');
  const team = manualTeams.find(t=>t.id===tid); if (!team) return;
  team.members = team.members.filter(m=>m!==name);
  renderManualTeamsBuilder();
}

function addManualTeam() {
  manualTeams.push({id:uid(), name:'Team '+(manualTeams.length+1), members:[]});
  renderManualTeamsBuilder();
}

function removeManualTeam(tid) {
  manualTeams = manualTeams.filter(t=>t.id!==tid);
  renderManualTeamsBuilder();
}



function renderModalPlayerChips() {
  const list = getCurrentList(); if (!list) return;
  list.persons.forEach(p => { if (p.active === undefined) p.active = true; });
  const chips = document.getElementById('modal-player-chips'); if (!chips) return;
  const counter = document.getElementById('modal-active-count');
  const activeCount = list.persons.filter(p=>p.active).length;
  if (counter) counter.textContent = activeCount + ' aktiv / ' + list.persons.length + ' gesamt';
  chips.innerHTML = list.persons.map(p =>
    `<span class="mini-chip ${p.active?'active':'inactive'}" onclick="togglePersonFromModal('${p.id}')">
      ${p.active?'‚úÖ':'‚õî'} ${p.name}
    </span>`
  ).join('');
}

function togglePersonFromModal(pid) {
  const list = getCurrentList(); if (!list) return;
  const p = list.persons.find(x=>x.id===pid); if (!p) return;
  p.active = !p.active;
  save();
  renderModalPlayerChips();
  renderPersons(); // keep persons tab in sync
}

function addPlayerFromModal() {
  const input = document.getElementById('modal-new-player');
  const name = input.value.trim(); if (!name) return;
  const list = getCurrentList(); if (!list) return;
  list.persons.push({ id: uid(), name, active: true });
  save(); input.value = '';
  renderModalPlayerChips();
  renderPersons();
}

function renderTournament() {
  const list = getCurrentList(); if (!list) return;
  if (!list.tournaments) list.tournaments = list.tournament ? [list.tournament] : [];
  // Show list view
  backToTournamentList();
}

function renderTournamentList() {
  const list = getCurrentList(); if (!list) return;
  if (!list.tournaments) list.tournaments = [];
  const container = document.getElementById('tournaments-container');
  const empty = document.getElementById('tournaments-empty');
  if (!list.tournaments.length) { empty.style.display='block'; container.innerHTML=''; return; }
  empty.style.display = 'none';
  const sorted = [...list.tournaments].sort((a,b) =>
    _tournamentSortAsc ? a.name.localeCompare(b.name) : b.name.localeCompare(a.name)
  );
  container.innerHTML = sorted.map(t => {
    const modeLabel = t.mode==='league' ? (t.returnRound ? '‚öΩ Liga H+R' : '‚öΩ Liga') : '‚ö° K.O.';
    const played = t.matches.filter(m=>m.scoreA!==null).length;
    const total = t.matches.length;
    return `<div class="list-nav-item" onclick="openTournament('${t.id}')" style="padding:14px 0;border-bottom:1px solid var(--border)">
      <div class="lni-icon" style="background:linear-gradient(135deg,var(--accent4),#d97706)">${t.mode==='league'?'‚öΩ':'‚ö°'}</div>
      <div class="lni-info">
        <div class="lni-name">${t.name}</div>
        <div class="lni-meta" style="font-size:12px;color:var(--text2)">${modeLabel} ¬∑ ${t.participants.length} Teams ¬∑ ${played}/${total} Spiele</div>
        <div class="t-progress"><div class="t-progress-fill" style="width:\${total>0?Math.round(played/total*100):0}%;background:\${played===total&&total>0?'var(--accent3)':'var(--accent)'}"></div></div>
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <button class="danger-list-btn" onclick="event.stopPropagation();deleteTournamentById('${t.id}')" title="Turnier l√∂schen">√ó</button>
        <div class="lni-arrow">‚Ä∫</div>
      </div>
    </div>`;
  }).join('');
}

function backToTournamentList() {
  document.getElementById('tournament-list-view').style.display = 'block';
  document.getElementById('tournament-detail-view').style.display = 'none';
  state.activeTournamentId = null;
  renderTournamentList();
}

function openTournament(tid) {
  state.activeTournamentId = tid;
  document.getElementById('tournament-list-view').style.display = 'none';
  document.getElementById('tournament-detail-view').style.display = 'block';
  renderActiveTournament();
}

function getActiveTournament() {
  const list = getCurrentList(); if (!list||!list.tournaments) return null;
  return list.tournaments.find(t=>t.id===state.activeTournamentId);
}

function renderActiveTournament() {
  const t = getActiveTournament(); if (!t) return;
  // Update tournament name in header
  const nameEl = document.getElementById('tournament-detail-name');
  if (nameEl) nameEl.textContent = t.name;
  // Update sticky progress bar
  const played = t.matches.filter(m=>m.scoreA!==null&&m.scoreB!==null).length;
  const total = t.matches.length;
  const pct = total > 0 ? Math.round(played/total*100) : 0;
  const fill = document.getElementById('t-detail-progress-fill');
  const stats = document.getElementById('t-detail-stats');
  if (fill) {
    fill.style.width = pct + '%';
    fill.style.background = played===total&&total>0 ? 'var(--accent3)' : 'var(--accent)';
  }
  if (stats) stats.textContent = played + '‚ÄØ/‚ÄØ' + total + ' Spiele';
  if (t.mode==='league') renderLeague(t);
  else renderKO(t);
}

function openRenameTournamentModal() {
  const t = getActiveTournament(); if (!t) return;
  document.getElementById('rename-tournament-input').value = t.name;
  openModal('modal-rename-tournament');
}

function renameTournament() {
  const name = document.getElementById('rename-tournament-input').value.trim();
  if (!name) return;
  const t = getActiveTournament(); if (!t) return;
  t.name = name; save(); closeModal('modal-rename-tournament');
  renderActiveTournament(); toast('‚úÖ Turnier umbenannt');
}

function deleteActiveTournament() {
  showConfirm('Turnier l√∂schen?', 'Das Turnier mit allen Ergebnissen wird gel√∂scht.', () => deleteTournamentById(state.activeTournamentId));
}

function deleteTournamentById(tid) {
  const list = getCurrentList(); if (!list) return;
  const tObj = (list.tournaments||[]).find(t=>t.id===tid);
  if (!tObj) return;
  const tIdx = list.tournaments.indexOf(tObj);
  list.tournaments = list.tournaments.filter(t=>t.id!==tid);
  save();
  if (state.activeTournamentId === tid) backToTournamentList();
  else renderTournamentList();
  toast('üóë ' + tObj.name + ' gel√∂scht', () => {
    list.tournaments.splice(tIdx, 0, tObj);
    save(); renderTournamentList();
    toast('‚Ü©Ô∏è ' + tObj.name + ' wiederhergestellt');
  });
}

function createTournament() {
  const list = getCurrentList(); if (!list) return;
  const name = document.getElementById('tournament-name-input').value.trim() || 'Turnier';
  const mode = document.getElementById('tournament-mode').value;
  const participantType = document.getElementById('tournament-participants').value;
  const ptsWin = parseInt(document.getElementById('pts-win').textContent);
  const ptsDraw = parseInt(document.getElementById('pts-draw').textContent);
  const returnRound = mode==='league' && document.getElementById('league-return-round').checked;

  let participants = [];

  if (participantType==='persons') {
    const ap2 = getActivePersons();
    if (ap2.length < 2) { toast('‚ö†Ô∏è Mindestens 2 aktive Personen'); return; }
    participants = ap2.map(p=>p.name);

  } else if (participantType==='teams-random') {
    const nTeams = parseInt(document.getElementById('t-teams-count').textContent);
    const ap3 = getActivePersons();
    if (nTeams > ap3.length) { toast('‚ö†Ô∏è Mehr Teams als aktive Personen'); return; }
    const shuffled = shuffle(ap3);
    const teams = Array.from({length:nTeams},()=>[]);
    shuffled.forEach((p,i)=>teams[i%nTeams].push(p.name));
    participants = teams.map((t,i)=>`${manualTeams[i]?.name||'Team '+(i+1)} (${t.join(', ')})`);
    // use auto-generated names
    participants = teams.map((members,i)=>`Team ${i+1} (${members.join(', ')})`);

  } else if (participantType==='teams-manual') {
    // validate
    const filledTeams = manualTeams.filter(t=>t.members.length>0);
    if (filledTeams.length < 2) { toast('‚ö†Ô∏è Mindestens 2 Teams mit Spielern'); return; }
    participants = filledTeams.map(t=>`${t.name} (${t.members.join(', ')})`);
  }

  const matches = [];
  if (mode==='league') {
    for (let i=0;i<participants.length;i++)
      for (let j=i+1;j<participants.length;j++) {
        matches.push({id:uid(),a:participants[i],b:participants[j],scoreA:null,scoreB:null,leg:1});
        if (returnRound)
          matches.push({id:uid(),a:participants[j],b:participants[i],scoreA:null,scoreB:null,leg:2});
      }
  } else {
    let size = 1; while(size < participants.length) size*=2;
    const bracket = [...participants];
    while (bracket.length < size) bracket.push('Freilos');
    for (let i=0;i<size;i+=2)
      matches.push({id:uid(),a:bracket[i],b:bracket[i+1],scoreA:null,scoreB:null,round:1});
  }

  if (!list.tournaments) list.tournaments = [];
  const newT = { id: uid(), name, mode, returnRound, participants, matches, ptsWin, ptsDraw, createdAt: Date.now() };
  list.tournaments.push(newT);
  // reset manual teams for next time
  manualTeams = [];
  save(); closeModal('modal-new-tournament');
  document.getElementById('tournament-name-input').value = '';
  toast('üèÜ Turnier erstellt!');
  openTournament(newT.id);
}

function renderLeague(t) {
  const tournamentView = document.getElementById('tournament-view');
  // Compute standings
  const standings = {};
  t.participants.forEach(p => standings[p]={p:0,w:0,d:0,l:0,gf:0,ga:0,pts:0});
  t.matches.forEach(m => {
    if (m.scoreA===null||m.scoreB===null) return;
    const a=m.scoreA, b=m.scoreB;
    standings[m.a].p++; standings[m.b].p++;
    standings[m.a].gf+=a; standings[m.a].ga+=b;
    standings[m.b].gf+=b; standings[m.b].ga+=a;
    if (a>b) { standings[m.a].w++; standings[m.a].pts+=t.ptsWin; standings[m.b].l++; }
    else if (a<b) { standings[m.b].w++; standings[m.b].pts+=t.ptsWin; standings[m.a].l++; }
    else { standings[m.a].d++; standings[m.a].pts+=t.ptsDraw; standings[m.b].d++; standings[m.b].pts+=t.ptsDraw; }
  });
  const rows = Object.entries(standings).map(([name,s])=>({name,...s,diff:s.gf-s.ga}));
  rows.sort((a,b)=>b.pts-a.pts||b.diff-a.diff||b.gf-a.gf);

  const winner = rows[0];
  const allPlayed = t.matches.every(m=>m.scoreA!==null&&m.scoreB!==null);

  const playedL = t.matches.filter(m=>m.scoreA!==null&&m.scoreB!==null).length;
  const totalL = t.matches.length;
  let html = `<div>`;

  if (allPlayed) html += `<div class="winner-banner"><div class="trophy">üèÜ</div><h2>Sieger: ${winner.name}</h2><p>${winner.pts} Punkte ¬∑ ${winner.w}S/${winner.d}U/${winner.l}N</p></div>`;

  html += `<div style="font-size:11px;color:var(--text3);margin-bottom:4px">Sp = Spiele &nbsp;¬∑&nbsp; S/U/N = Siege/Unentschieden/Niederlagen &nbsp;¬∑&nbsp; Pts = Punkte</div>`;
  html += `<div class="overflow-wrap" style="overflow-x:auto"><table class="standings-table">
    <thead><tr><th>#</th><th style="text-align:left">Name</th><th title="Spiele">Sp</th><th title="Siege">S</th><th title="Unentschieden">U</th><th title="Niederlagen">N</th><th title="Tore:Gegentore">Tore</th><th title="Tordifferenz">+/-</th><th title="Punkte">Pts</th></tr></thead>
    <tbody>`;
  rows.forEach((r,i) => {
    const diffColor = r.diff>0?'var(--accent3)':r.diff<0?'var(--danger)':'var(--text2)';
    const diffStr = r.diff>0?'+'+r.diff:String(r.diff);
    html += `<tr><td><span class="pos">${i+1}</span></td><td>${r.name}</td><td>${r.p}</td><td>${r.w}</td><td>${r.d}</td><td>${r.l}</td><td style="font-family:'JetBrains Mono',monospace;font-size:12px">${r.gf}:${r.ga}</td><td style="font-weight:700;color:${diffColor}">${diffStr}</td><td style="font-weight:800;color:var(--accent)">${r.pts}</td></tr>`;
  });
  html += `</tbody></table></div><div class="divider"></div><div style="font-size:14px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:.05em;margin-bottom:10px">Spielplan</div>`;

  // Group matches by leg if return round
  const hasReturn = t.returnRound;
  if (hasReturn) {
    const legs = [t.matches.filter(m=>m.leg!==2), t.matches.filter(m=>m.leg===2)];
    const legLabels = ['Hinrunde','R√ºckrunde'];
    const legIds = ['leg-hin','leg-rueck'];
    const legCollapsed = t._legCollapsed || [false, false]; // both open by default
    legs.forEach((legMatches, li) => {
      if (!legMatches.length) return;
      const collapsed = legCollapsed[li];
      const arrow = collapsed ? '‚ñ∂' : '‚ñº';
      html += `<div class="ko-round-label" style="display:flex;align-items:center;justify-content:space-between;cursor:pointer;user-select:none"
        onclick="toggleLeg(${li})">
        <span>${legLabels[li]}</span>
        <span style="font-size:11px;color:var(--text3)">${arrow}</span>
      </div>`;
      html += `<div id="${legIds[li]}" style="display:${collapsed?'none':'block'}">`;
      legMatches.forEach(m => { html += matchHTML(m); });
      html += '</div>';
    });
  } else {
    t.matches.forEach(m => { html += matchHTML(m); });
  }
  html += '</div>';
  tournamentView.innerHTML = html;
}

function matchHTML(m) {
  const played = m.scoreA !== null;
  const sa = m.scoreA !== null ? m.scoreA : '';
  const sb = m.scoreB !== null ? m.scoreB : '';
  const winA = played && m.scoreA > m.scoreB;
  const winB = played && m.scoreB > m.scoreA;
  return `<div class="bracket-match">
    <div class="bm-row${winA?' bm-winner':''}">
      <span class="bm-name">${m.a}</span>
      <div class="bm-stepper">
        <button class="bm-step-btn" onclick="stepScore('${m.id}','a',-1)">‚àí</button>
        <input class="bm-score" type="number" min="0" value="${sa}" placeholder="‚Äì"
          id="sc-${m.id}-a"
          onblur="updateScore('${m.id}','a',this.value)">
        <button class="bm-step-btn" onclick="stepScore('${m.id}','a',1)">+</button>
      </div>
    </div>
    <div class="bm-row${winB?' bm-winner':''}">
      <span class="bm-name">${m.b}</span>
      <div class="bm-stepper">
        <button class="bm-step-btn" onclick="stepScore('${m.id}','b',-1)">‚àí</button>
        <input class="bm-score" type="number" min="0" value="${sb}" placeholder="‚Äì"
          id="sc-${m.id}-b"
          onblur="updateScore('${m.id}','b',this.value)">
        <button class="bm-step-btn" onclick="stepScore('${m.id}','b',1)">+</button>
      </div>
    </div>
  </div>`;
}

function renderKO(t) {
  const tournamentView = document.getElementById('tournament-view');
  const rounds = {};
  t.matches.forEach(m => {
    const r = m.round||1;
    if (!rounds[r]) rounds[r] = [];
    rounds[r].push(m);
  });
  const maxRound = Math.max(...Object.keys(rounds).map(Number));
  const lastMatch = rounds[maxRound];
  const allFinalPlayed = lastMatch && lastMatch.every(m=>m.scoreA!==null&&m.scoreB!==null);
  let finalWinner = null;
  if (allFinalPlayed && lastMatch.length===1) {
    const m = lastMatch[0];
    finalWinner = m.scoreA >= m.scoreB ? m.a : m.b;
  }

  let html = `<div>`;
  if (finalWinner) html += `<div class="winner-banner"><div class="trophy">üèÜ</div><h2>Sieger: ${finalWinner}</h2><p>K.O.-Sieger</p></div>`;

  const roundNames = {};
  for (let r=1;r<=maxRound;r++) {
    const remaining = maxRound - r;
    if (remaining===0) roundNames[r]='Finale';
    else if (remaining===1) roundNames[r]='Halbfinale';
    else if (remaining===2) roundNames[r]='Viertelfinale';
    else roundNames[r] = `Runde ${r}`;
  }

  Object.entries(rounds).forEach(([round, matches]) => {
    html += `<div class="ko-round-label">${roundNames[round]||'Runde '+round}</div>`;
    matches.forEach(m => {
      if (m.a==='Freilos'||m.b==='Freilos') {
        const real = m.a==='Freilos'?m.b:m.a;
        html += `<div class="bracket-match">
          <div class="bm-row bm-winner"><span class="bm-name">${real}</span><span style="font-size:12px;color:var(--accent3)">Freilos ‚úì</span></div>
        </div>`;
        return;
      }
      const played = m.scoreA!==null;
      html += matchHTML(m);
    });
  });

  if (!finalWinner) html += `<div style="margin-top:12px"><button class="btn btn-primary btn-full" onclick="advanceKO()">‚ö° Sieger zur n√§chsten Runde</button></div>`;
  html += '</div>';
  tournamentView.innerHTML = html;
}

function updateScore(matchId, side, val) {
  const list = getCurrentList(); if (!list) return;
  const t = getActiveTournament(); if (!t) return;
  const m = t.matches.find(x=>x.id===matchId); if (!m) return;
  const v = (val===''||val===null) ? null : parseInt(val);
  if (side==='a') m.scoreA = (isNaN(v)||val==='') ? null : v;
  else m.scoreB = (isNaN(v)||val==='') ? null : v;
  save();

  // Update winner highlights on this match
  const inputA = document.getElementById('sc-'+matchId+'-a');
  const inputB = document.getElementById('sc-'+matchId+'-b');
  [inputA, inputB].forEach(inp => { if (inp) inp.closest('.bm-row')?.classList.remove('bm-winner'); });
  if (m.scoreA !== null && m.scoreB !== null) {
    if (m.scoreA > m.scoreB) inputA?.closest('.bm-row')?.classList.add('bm-winner');
    else if (m.scoreB > m.scoreA) inputB?.closest('.bm-row')?.classList.add('bm-winner');
  }

  // Live-update standings table (no full re-render)
  if (t.mode === 'league') updateStandingsTable(t);
}

function stepScore(matchId, side, delta) {
  const t = getActiveTournament(); if (!t) return;
  const m = t.matches.find(x=>x.id===matchId); if (!m) return;
  const current = side==='a' ? m.scoreA : m.scoreB;

  // + starts at 1 if field was empty, - only goes down to 0
  let next;
  next = Math.max(0, (current===null ? 0 : current) + delta);

  if (side==='a') m.scoreA = next;
  else m.scoreB = next;
  save();

  // 1. Update inputs in DOM
  const inputA = document.getElementById('sc-'+matchId+'-a');
  const inputB = document.getElementById('sc-'+matchId+'-b');
  if (inputA) inputA.value = m.scoreA !== null ? m.scoreA : '';
  if (inputB) inputB.value = m.scoreB !== null ? m.scoreB : '';

  // 2. Winner highlight only when BOTH scores set
  [inputA, inputB].forEach(inp => { if (inp) inp.closest('.bm-row')?.classList.remove('bm-winner'); });
  if (m.scoreA !== null && m.scoreB !== null) {
    if (m.scoreA > m.scoreB) inputA?.closest('.bm-row')?.classList.add('bm-winner');
    else if (m.scoreB > m.scoreA) inputB?.closest('.bm-row')?.classList.add('bm-winner');
  }

  if (t.mode === 'league') updateStandingsTable(t);
}

function updateStandingsTable(t) {
  const standings = {};
  t.participants.forEach(p => standings[p]={p:0,w:0,d:0,l:0,gf:0,ga:0,pts:0});
  t.matches.forEach(mm => {
    if (mm.scoreA===null||mm.scoreB===null) return;
    const a=mm.scoreA, b=mm.scoreB;
    standings[mm.a].p++; standings[mm.b].p++;
    standings[mm.a].gf+=a; standings[mm.a].ga+=b;
    standings[mm.b].gf+=b; standings[mm.b].ga+=a;
    if (a>b) { standings[mm.a].w++; standings[mm.a].pts+=t.ptsWin; standings[mm.b].l++; }
    else if (a<b) { standings[mm.b].w++; standings[mm.b].pts+=t.ptsWin; standings[mm.a].l++; }
    else { standings[mm.a].d++; standings[mm.a].pts+=t.ptsDraw; standings[mm.b].d++; standings[mm.b].pts+=t.ptsDraw; }
  });
  const rows = Object.entries(standings).map(([name,s])=>({name,...s,diff:s.gf-s.ga}));
  rows.sort((a,b)=>b.pts-a.pts||b.diff-a.diff||b.gf-a.gf);

  const tbody = document.querySelector('.standings-table tbody');
  if (!tbody) return;
  tbody.innerHTML = rows.map((r,i) => {
    const diffColor = r.diff>0?'var(--accent3)':r.diff<0?'var(--danger)':'var(--text2)';
    const diffStr = r.diff>0?'+'+r.diff:String(r.diff);
    return `<tr><td><span class="pos">${i+1}</span></td><td>${r.name}</td><td>${r.p}</td><td>${r.w}</td><td>${r.d}</td><td>${r.l}</td><td style="font-family:'JetBrains Mono',monospace;font-size:12px">${r.gf}:${r.ga}</td><td style="font-weight:700;color:${diffColor}">${diffStr}</td><td style="font-weight:800;color:var(--accent)">${r.pts}</td></tr>`;
  }).join('');

  // Show/hide winner banner
  const allPlayed = t.matches.every(mm=>mm.scoreA!==null&&mm.scoreB!==null);
  let banner = document.querySelector('.winner-banner');
  if (allPlayed && !banner) {
    banner = document.createElement('div');
    banner.className = 'winner-banner';
    const tv = document.getElementById('tournament-view');
    tv.insertBefore(banner, tv.firstChild);
  }
  if (banner) {
    if (allPlayed) {
      banner.style.display = '';
      banner.innerHTML = `<div class="trophy">üèÜ</div><h2>Sieger: ${rows[0].name}</h2><p>${rows[0].pts} Punkte ¬∑ ${rows[0].w}S/${rows[0].d}U/${rows[0].l}N</p>`;
    } else {
      banner.style.display = 'none';
    }
  }
}

function advanceKO() {
  const list = getCurrentList(); if (!list) return;
  const t = getActiveTournament(); if (!t) return;
  const maxRound = Math.max(...t.matches.map(m=>m.round||1));
  const currentRoundMatches = t.matches.filter(m=>(m.round||1)===maxRound);
  if (!currentRoundMatches.every(m=>m.scoreA!==null||m.a==='Freilos'||m.b==='Freilos')) {
    toast('‚ö†Ô∏è Erst alle Spiele dieser Runde eintragen'); return;
  }
  if (currentRoundMatches.length === 1) { toast('üèÜ Turnier abgeschlossen!'); renderActiveTournament(); return; }
  const winners = currentRoundMatches.map(m => {
    if (m.a==='Freilos') return m.b;
    if (m.b==='Freilos') return m.a;
    return m.scoreA>=m.scoreB?m.a:m.b;
  });
  for (let i=0;i<winners.length;i+=2) {
    t.matches.push({id:uid(),a:winners[i],b:winners[i+1]||'Freilos',scoreA:null,scoreB:null,round:maxRound+1});
  }
  save(); renderActiveTournament(); toast('‚úÖ N√§chste Runde gestartet!');
}

// ‚îÄ‚îÄ Swipe-to-delete ‚îÄ‚îÄ
let _swipeStartX = 0;
let _swipeEl = null;
const SWIPE_THRESHOLD = 80;

function swipeStart(e, el) {
  _swipeStartX = e.touches[0].clientX;
  _swipeEl = el;
  el.classList.add('swiping');
}

function swipeMove(e, el) {
  const dx = _swipeStartX - e.touches[0].clientX;
  if (dx < 0) { el.style.transform = ''; return; }
  const clamped = Math.min(dx, 120);
  el.style.transform = 'translateX(-' + clamped + 'px)';
  const lid = el.dataset.lid;
  const bg = document.getElementById('delbg-' + lid);
  if (bg) bg.style.opacity = Math.min(dx / SWIPE_THRESHOLD, 1);
}

function swipeEnd(e, el) {
  el.classList.remove('swiping');
  const dx = _swipeStartX - (e.changedTouches[0]?.clientX || _swipeStartX);
  const lid = el.dataset.lid;
  const bg = document.getElementById('delbg-' + lid);
  if (dx > SWIPE_THRESHOLD) {
    // Confirm with spring-back animation
    el.style.transform = 'translateX(-100%)';
    el.style.transition = 'transform .3s ease';
    if (bg) bg.style.opacity = '1';
    setTimeout(() => deleteListById(lid), 250);
  } else {
    el.style.transform = '';
    if (bg) bg.style.opacity = '0';
  }
  _swipeEl = null;
}

// ===================== UTILS =====================
function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2,7); }

// ‚îÄ‚îÄ Custom confirm dialog ‚îÄ‚îÄ
let _confirmCallback = null;
function showConfirm(title, msg, onOk, okLabel) {
  _confirmCallback = onOk;
  document.getElementById('confirm-title').textContent = title;
  document.getElementById('confirm-msg').textContent = msg;
  document.getElementById('confirm-ok-btn').textContent = okLabel || 'L√∂schen';
  document.getElementById('confirm-overlay').classList.add('open');
}
function confirmOK() {
  document.getElementById('confirm-overlay').classList.remove('open');
  if (_confirmCallback) { _confirmCallback(); _confirmCallback = null; }
}
function confirmCancel() {
  document.getElementById('confirm-overlay').classList.remove('open');
  _confirmCallback = null;
}

// ‚îÄ‚îÄ Modal swipe-to-close ‚îÄ‚îÄ
let _modalDragId = null, _modalDragStartY = 0, _modalDragCurrentY = 0;

function modalTouchStart(e, id) {
  _modalDragId = id;
  _modalDragStartY = e.touches[0].clientY;
  _modalDragCurrentY = 0;
  const modal = document.querySelector('#' + id + ' .modal');
  if (modal) modal.classList.add('dragging');
}
function modalTouchMove(e, id) {
  if (_modalDragId !== id) return;
  const dy = e.touches[0].clientY - _modalDragStartY;
  if (dy < 0) return; // no dragging upward
  _modalDragCurrentY = dy;
  const modal = document.querySelector('#' + id + ' .modal');
  if (modal) modal.style.transform = 'translateY(' + dy + 'px)';
}
function modalTouchEnd(e, id) {
  if (_modalDragId !== id) return;
  const modal = document.querySelector('#' + id + ' .modal');
  if (!modal) return;
  modal.classList.remove('dragging');
  if (_modalDragCurrentY > 120) {
    // Close
    modal.style.transform = '';
    closeModal(id);
    if (typeof navigator.vibrate === 'function') navigator.vibrate(30);
  } else {
    // Snap back
    modal.style.transition = 'transform .25s ease';
    modal.style.transform = 'translateY(0)';
    setTimeout(() => { modal.style.transition = ''; }, 260);
  }
  _modalDragId = null;
}

// ===================== MODAL ‚îÄ single definition =====================
function openModal(id) {
  if (id==='modal-rename-list') {
    const list = getCurrentList();
    if (list) {
      document.getElementById('rename-list-input').value = list.name;
      renderManagePersonChips();
    }
  }
  if (id==='modal-new-tournament') {
    document.getElementById('tournament-participants').value = 'persons';
    document.getElementById('tournament-mode').value = 'league';
    document.getElementById('teams-count-row').style.display = 'none';
    document.getElementById('manual-teams-builder').style.display = 'none';
    document.getElementById('return-round-row').style.display = 'block';
    document.getElementById('league-return-round').checked = true;
    // Reset collapse state ‚Äì body collapsed, arrow rotated
    const _rrb = document.getElementById('return-round-body');
    const _rra = document.getElementById('return-round-arrow');
    if (_rrb) _rrb.style.display = 'none';
    if (_rra) _rra.style.transform = 'rotate(-90deg)';
    // Reset advanced settings
    const _adv = document.getElementById('adv-settings');
    const _adva = document.getElementById('adv-arrow');
    if (_adv) _adv.style.display = 'none';
    if (_adva) _adva.style.transform = 'rotate(-90deg)';
    manualTeams = [];
    setTimeout(renderModalPlayerChips, 50);
  }
  document.getElementById(id).classList.add('open');
  if (id === 'modal-new-tournament') {
    setTimeout(()=>document.getElementById('tournament-name-input')?.focus(), 300);
  } else {
    const inp = document.getElementById(id)?.querySelector('input');
    if (inp) setTimeout(()=>inp.focus(), 300);
  }
}

// ‚îÄ‚îÄ Timestamp for tournament name ‚îÄ‚îÄ
function setTournamentTimestamp() {
  const now = new Date();
  const d = now.getDate().toString().padStart(2,'0');
  const mo = (now.getMonth()+1).toString().padStart(2,'0');
  const y = now.getFullYear();
  const h = now.getHours().toString().padStart(2,'0');
  const mi = now.getMinutes().toString().padStart(2,'0');
  document.getElementById('tournament-name-input').value = `${d}.${mo}.${y} ${h}:${mi}`;
}

// ‚îÄ‚îÄ Tournament sort ‚îÄ‚îÄ
let _tournamentSortAsc = true;
function toggleTournamentSort() {
  _tournamentSortAsc = !_tournamentSortAsc;
  const btn = document.getElementById('sort-btn');
  if (btn) btn.textContent = _tournamentSortAsc ? 'A‚Üë' : 'Z‚Üì';
  renderTournamentList();
}

// ‚îÄ‚îÄ Collapsible Hin/R√ºckrunde in Spielplan ‚îÄ‚îÄ
function toggleLeg(legIndex) {
  const t = getActiveTournament(); if (!t) return;
  if (!t._legCollapsed) t._legCollapsed = [false, true];
  t._legCollapsed[legIndex] = !t._legCollapsed[legIndex];
  // Don't save to storage (UI state only), just re-render
  renderActiveTournament();
}

// ‚îÄ‚îÄ ACTIVE BANNER (Aktionen-Tab) ‚îÄ‚îÄ
function renderActiveBanner() {
  const list = getCurrentList(); 
  const bannerCount = document.getElementById('banner-count');
  const bannerChips = document.getElementById('banner-chips');
  if (!bannerCount || !bannerChips) return;
  if (!list || !list.persons.length) {
    bannerCount.textContent = 'Niemand eingetragen';
    bannerChips.innerHTML = '<span style="font-size:13px;color:var(--text3)">Gehe zu ‚ÄûGruppe" und f√ºge Spieler hinzu ‚Üí</span>';
    renderQuickRepeat();
    return;
  }
  list.persons.forEach(p => { if (p.active === undefined) p.active = true; });
  const active = list.persons.filter(p=>p.active);
  const inactive = list.persons.filter(p=>!p.active);
  bannerCount.textContent = active.length + ' dabei ¬∑ ' + (inactive.length ? inactive.length + ' fehlen heute' : 'alle dabei ‚úì');
  bannerChips.innerHTML = 
    active.map(p=>`<span class="ab-chip on" onclick="togglePerson('${p.id}');renderActiveBanner()">‚úì ${p.name}</span>`).join('') +
    inactive.map(p=>`<span class="ab-chip off" onclick="togglePerson('${p.id}');renderActiveBanner()">${p.name}</span>`).join('');
  renderQuickRepeat();
  renderSessionRecall();
}

// ‚îÄ‚îÄ Quick-Repeat: Letzte History-Aktion oben anzeigen ‚îÄ‚îÄ
function renderQuickRepeat() {
  const list = getCurrentList();
  const banner = document.getElementById('quick-repeat-banner');
  if (!banner) return;
  const repeatableTypes = ['teams','pairs','volunteer','order','allvsall'];
  const hist = list && list.history
    ? list.history.find(h => repeatableTypes.includes(h.type))
    : null;
  if (!hist) { banner.style.display = 'none'; return; }
  banner.style.display = 'block';
  banner.querySelector('#quick-repeat-icon').textContent = 
    {teams:'üë•',pairs:'ü§ù',volunteer:'üéØ',order:'üîÄ',allvsall:'‚öîÔ∏è'}[hist.type] || 'üîÑ';
  banner.querySelector('#quick-repeat-label').textContent = hist.title;
  const ago = formatAgo(hist.createdAt);
  banner.querySelector('#quick-repeat-meta').textContent = ago;
  // pulse once on first show per session
  const inner = document.getElementById('quick-repeat-inner');
  if (inner && !inner.dataset.pulsed) {
    inner.classList.add('quick-repeat-pulse');
    inner.dataset.pulsed = '1';
    setTimeout(() => inner.classList.remove('quick-repeat-pulse'), 1000);
  }
}

function quickRepeatLastAction() {
  const list = getCurrentList(); if (!list || !list.history.length) return;
  const repeatableTypes = ['teams','pairs','volunteer','order','allvsall'];
  const h = list.history.find(x => repeatableTypes.includes(x.type));
  if (!h) return;
  state.pendingResult = { type: h.type, title: h.title, data: h.data };
  repeatLastAction();
}

function formatAgo(ts) {
  const diff = Date.now() - ts;
  const mins = Math.floor(diff / 60000);
  const hours = Math.floor(diff / 3600000);
  const days = Math.floor(diff / 86400000);
  if (mins < 2) return 'Gerade eben';
  if (mins < 60) return `vor ${mins} Min.`;
  if (hours < 24) return `vor ${hours} Std.`;
  if (days === 1) return 'Gestern';
  return `vor ${days} Tagen`;
}

// ‚îÄ‚îÄ Session-Persistenz: Gleiche Aufstellung wie letzte Woche? ‚îÄ‚îÄ
function renderSessionRecall() {
  const list = getCurrentList();
  const banner = document.getElementById('session-recall-banner');
  if (!banner || !list) return;
  // Only show if: last session saved, it differs from current, and user hasn't dismissed
  const recalled = list._lastSessionActive;
  if (!recalled || !recalled.length || list._sessionDismissed) { banner.style.display = 'none'; return; }
  const currentActive = list.persons.filter(p=>p.active!==false).map(p=>p.name).sort().join(',');
  const lastActive = [...recalled].sort().join(',');
  if (currentActive === lastActive) { banner.style.display = 'none'; return; }
  // Check last session was at least 3 hours ago (not same session)
  if (list._lastSessionTime && Date.now() - list._lastSessionTime < 3 * 3600000) { banner.style.display = 'none'; return; }
  banner.style.display = 'block';
  const names = recalled.slice(0, 5).join(', ') + (recalled.length > 5 ? ` +${recalled.length - 5}` : '');
  document.getElementById('session-recall-names').textContent = names;
}

function applyLastSession() {
  const list = getCurrentList(); if (!list || !list._lastSessionActive) return;
  list.persons.forEach(p => {
    p.active = list._lastSessionActive.includes(p.name);
  });
  list._sessionDismissed = true; // won't show again this session
  save();
  document.getElementById('session-recall-banner').style.display = 'none';
  renderActiveBanner();
  const n = list.persons.filter(p=>p.active).length;
  toast('‚úÖ ' + n + ' Spieler √ºbernommen ‚Äì bereit!');
}

function dismissSessionRecall() {
  const list = getCurrentList(); if (!list) return;
  list._sessionDismissed = true;
  save();
  document.getElementById('session-recall-banner').style.display = 'none';
}

// Save active session when an action is run (called before showResult)
function saveSessionSnapshot() {
  const list = getCurrentList(); if (!list) return;
  const activeNames = list.persons.filter(p=>p.active!==false).map(p=>p.name);
  list._lastSessionActive = activeNames;
  list._lastSessionTime = Date.now();
  list._sessionDismissed = false;
  save();
}

// ‚îÄ‚îÄ SHARE RESULT ‚îÄ‚îÄ
function shareResult() {
  const r = state.pendingResult; if (!r) return;
  let text = r.title + '\n\n';
  if (r.type === 'teams') {
    text += r.data.map((t,i)=>`Team ${i+1}: ${t.join(', ')}`).join('\n');
  } else if (r.type === 'pairs') {
    text += r.data.map((g,i)=>`${i+1}. ${g.join(' + ')}`).join('\n');
  } else if (r.type === 'volunteer') {
    text += r.data.map((n,i)=>`${i+1}. ${n}`).join('\n');
  } else if (r.type === 'order') {
    text += r.data.map((n,i)=>`${i+1}. ${n}`).join('\n');
  } else if (r.type === 'allvsall') {
    text += r.data.map((p,i)=>`${i+1}. ${p[0]} vs ${p[1]}`).join('\n');
  }
  text += '\n\n‚Äì ausgelost mit Spielr';
  if (navigator.share) {
    navigator.share({ title: r.title, text });
  } else {
    navigator.clipboard.writeText(text).then(()=>toast('üìã In Zwischenablage kopiert!'));
  }
}

// ‚îÄ‚îÄ SHARE TOURNAMENT ‚îÄ‚îÄ
function shareTournament() {
  const t = getActiveTournament(); if (!t) return;
  const standings = {};
  t.participants.forEach(p => standings[p]={p:0,w:0,d:0,l:0,gf:0,ga:0,pts:0});
  t.matches.forEach(m => {
    if (m.scoreA===null||m.scoreB===null) return;
    const a=m.scoreA, b=m.scoreB;
    standings[m.a].p++; standings[m.b].p++;
    standings[m.a].gf+=a; standings[m.a].ga+=b;
    standings[m.b].gf+=b; standings[m.b].ga+=a;
    if (a>b){standings[m.a].w++;standings[m.a].pts+=t.ptsWin;standings[m.b].l++;}
    else if(a<b){standings[m.b].w++;standings[m.b].pts+=t.ptsWin;standings[m.a].l++;}
    else{standings[m.a].d++;standings[m.a].pts+=t.ptsDraw;standings[m.b].d++;standings[m.b].pts+=t.ptsDraw;}
  });
  const rows = Object.entries(standings).map(([name,s])=>({name,...s,diff:s.gf-s.ga}));
  rows.sort((a,b)=>b.pts-a.pts||b.diff-a.diff||b.gf-a.gf);
  let text = 'üèÜ ' + t.name + '\n';
  text += '‚îÄ'.repeat(30) + '\n';
  rows.forEach((r,i) => {
    text += `${i+1}. ${r.name}  ${r.pts}Pts  ${r.gf}:${r.ga}\n`;
  });
  text += '\n‚Äì Spielr';
  if (navigator.share) {
    navigator.share({ title: t.name, text });
  } else {
    navigator.clipboard.writeText(text).then(()=>toast('üìã Tabelle kopiert!'));
  }
}

// ‚îÄ‚îÄ REPEAT LAST ACTION ‚îÄ‚îÄ
function repeatLastAction() {
  const r = state.pendingResult; if (!r) return;
  if (r.type==='teams') { 
    const list = getCurrentList(); if (!list) return;
    const n = r.data.length;
    const ap = getActivePersons();
    if (n > ap.length) { toast('‚ö†Ô∏è Nicht genug aktive Personen'); return; }
    const shuffled = shuffle(ap);
    const teams = Array.from({length:n},()=>[]);
    shuffled.forEach((p,i)=>teams[i%n].push(p.name));
    state.pendingResult = { type:'teams', title:r.title, data:teams };
  } else if (r.type==='pairs') {
    const size = r.data[0]?.length || 2;
    const shuffled = shuffle(getActivePersons());
    const groups = [];
    for(let i=0;i<shuffled.length;i+=size) groups.push(shuffled.slice(i,i+size).map(p=>p.name));
    state.pendingResult = { type:'pairs', title:r.title, data:groups };
  } else if (r.type==='volunteer') {
    const n = r.data.length;
    const avail = getActivePersons();
    if(n>avail.length){toast('‚ö†Ô∏è Nicht genug aktive Personen');return;}
    state.pendingResult = { type:'volunteer', title:r.title, data: shuffle(avail).slice(0,n).map(p=>p.name) };
  } else if (r.type==='order') {
    state.pendingResult = { type:'order', title:r.title, data: shuffle(getActivePersons()).map(p=>p.name) };
  } else if (r.type==='allvsall') {
    const persons = getActivePersons().map(p=>p.name);
    const pairs = [];
    for(let i=0;i<persons.length;i++)
      for(let j=i+1;j<persons.length;j++) pairs.push([persons[i],persons[j]]);
    state.pendingResult = { type:'allvsall', title:r.title, data:pairs };
  }
  showResult();
}

// ‚îÄ‚îÄ REPEAT FROM HISTORY ‚îÄ‚îÄ
function repeatHistory(hid) {
  const list = getCurrentList(); if (!list) return;
  const h = list.history.find(x=>x.id===hid); if (!h) return;
  state.pendingResult = { type: h.type, title: h.title, data: h.data };
  repeatLastAction();
}

// ‚îÄ‚îÄ DEMO DATA ‚îÄ‚îÄ
function loadDemoData() {
  const demoList = {
    id: uid(),
    name: 'Demo ‚Äì Hobbyteam',
    createdAt: Date.now(),
    persons: ['Pascal','Fabrizio','Thomas','Rene','Taha','Nedal','Luca','Gio','Waldemar'].map(name=>({id:uid(),name,active:true})),
    history: [],
    tournaments: []
  };
  state.lists.push(demoList);
  save();
  renderLists();
  openList(demoList.id);
  toast('‚ö° Demo geladen ‚Äì bereit zum Spielen!');
}


// ‚îÄ‚îÄ Turnier eigenst√§ndiger Einstieg vom Aktionen-Screen ‚îÄ‚îÄ
function startTournamentFromActions() {
  // If tournaments exist: go to tournament tab to pick up where left off
  const list = getCurrentList();
  const hasTournaments = list && list.tournaments && list.tournaments.length > 0;
  if (hasTournaments) {
    switchTab('tournament');
  } else {
    // No tournament yet: open creation modal directly
    switchTab('tournament');
    openModal('modal-new-tournament');
  }
}

// ‚îÄ‚îÄ Manage Modal: Personen inline verwalten ‚îÄ‚îÄ
function renderManagePersonChips() {
  const list = getCurrentList(); if (!list) return;
  list.persons.forEach(p => { if (p.active === undefined) p.active = true; });
  const chips = document.getElementById('manage-person-chips');
  const counter = document.getElementById('manage-active-count');
  if (!chips) return;
  const activeCount = list.persons.filter(p=>p.active).length;
  if (counter) counter.textContent = activeCount + ' / ' + list.persons.length + ' dabei';
  chips.innerHTML = list.persons.length === 0
    ? '<span style="font-size:13px;color:var(--text3);padding:4px 2px">Noch keine Spieler</span>'
    : list.persons.map(p =>
        `<span class="manage-chip ${p.active?'on':'off'}" onclick="togglePersonFromManage('${p.id}')">
          ${p.name}
          <button class="mc-del" onclick="event.stopPropagation();deletePersonFromManage('${p.id}')" title="Entfernen">√ó</button>
        </span>`
      ).join('');
}

function togglePersonFromManage(pid) {
  const list = getCurrentList(); if (!list) return;
  const p = list.persons.find(x=>x.id===pid); if (!p) return;
  p.active = !p.active;
  save(); renderManagePersonChips(); renderPersons(); renderActiveBanner();
}

function deletePersonFromManage(pid) {
  const list = getCurrentList(); if (!list) return;
  list.persons = list.persons.filter(p=>p.id!==pid);
  save(); renderManagePersonChips(); renderPersons(); renderActiveBanner();
}

function addPersonFromManage() {
  const input = document.getElementById('manage-new-person');
  const name = input.value.trim(); if (!name) return;
  const list = getCurrentList(); if (!list) return;
  list.persons.push({ id: uid(), name, active: true });
  save(); input.value = '';
  renderManagePersonChips(); renderPersons(); renderActiveBanner();
}

// ‚îÄ‚îÄ Advanced Settings accordion ‚îÄ‚îÄ
function toggleAdvancedSettings() {
  const body = document.getElementById('adv-settings');
  const arrow = document.getElementById('adv-arrow');
  const open = body.style.display !== 'none';
  body.style.display = open ? 'none' : 'block';
  arrow.style.transform = open ? 'rotate(-90deg)' : 'rotate(0deg)';
}


</script>
</body>
</html>
